---
title: \sffamily{\bfseries{\LARGE Criminal History Records Paper Step 2 (Analysis)}}
geometry: "left=.5in,right=.5in,top=.75in,bottom=.75in"
author: "Steven J. Pierce"
output:
 pdf_document:
   latex_engine: xelatex
   number_sections: true
   toc: yes
   toc_depth: 4
   includes:
     in_header: "compact-title.tex"
urlcolor: blue
header-includes:
- \usepackage{fancyhdr}
- \usepackage[yyyymmdd,hhmmss]{datetime}
- \usepackage{lastpage}
- \usepackage{fontspec}
- \defaultfontfeatures{Ligatures=TeX}
- \usepackage[font={small}, margin=1cm, skip=2pt]{caption}
- \usepackage{url}
- \usepackage{floatrow}
- \floatplacement{figure}{!ht}
- \floatplacement{table}{!ht}
- \usepackage{placeins}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{dcolumn}
- \usepackage{titling}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \pretitle{\begin{center}\LARGE\bfseries}
- \posttitle{\end{center}}
- \pagestyle{fancy}
- \lhead{SSA CHR Paper Step 2 Analysis}
- \rhead{\today\ \currenttime}
- \lfoot{\texttt{\small \detokenize{`r sub(".Rmd", ".pdf", knitr:::current_input(dir = FALSE))`}}} 
- \cfoot{ }
- \fancyfoot[R]{\thepage\ of \pageref*{LastPage}}
- \renewcommand{\headrulewidth}{0.4pt}
- \renewcommand{\footrulewidth}{0.4pt}
- \fancypagestyle{plain}{\pagestyle{fancy}}
---

********************************************************************************  
\FloatBarrier

# Purpose
This file analyzes data derived from publicly archived data files (Campbell,
2019) to produce outputs for a descriptive paper about the criminal histories of
suspected serial sexual perpetrators.^[In this document, we use the terms
perpetrator and offender interchangeably. Both terms should be interpreted as
referring to individuals suspected of committing a crime but we occasionally
omit that qualifier for the sake of brevity.] The data come from Detroit, MI.

\FloatBarrier

# Setup
Set global R chunk options (local chunk options will over-ride global options). 
The method for creating a size option that controls font size in code chunks and
their text output is based on an answer to a question posted on   
[stackoverflow.com](https://stackoverflow.com/questions/25646333/code-chunk-font-size-in-rmarkdown-with-knitr-and-latex/46526740#46526740). 

``` {r global_options, cfsize = "footnotesize"}
# Create a custom chunk hook/option for controlling font size in chunk & output.
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$cfsize != "normalsize", paste0("\n \\", options$cfsize,"\n\n", 
                                              x, "\n\n \\normalsize"), x)
  })

# Global chunk options (over-ridden by local chunk options)
knitr::opts_chunk$set(include  = TRUE, echo = TRUE, error = TRUE, 
                      message = TRUE, warning = TRUE, cfsize = "footnotesize")
```

Load R packages that we need to get additional functions. 

``` {r load_packages}
library(here)             # for here()
library(plyr)             # For mapvalues()
library(dplyr)            # for %>%, filter(), group_by(), & summarise()
library(tidyr)            # for arrange(), filter(), group_by(), mutate(),  
                          # spread(), summarise(), %>%, etc. 
library(rmarkdown)        # for render()
library(knitr)            # for kable()
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)       # for kable_styling(), add_header_above(), column_spec(),
                          # collapse_rows(), and landscape()
library(descr)            # For freq().
options(descr.plot=FALSE) # Make freq() & crosstab() skip plots by default.
library(lubridate)        # For date conversion, eg. ymd(), time_length().
library(sjlabelled)       # For set_label(), get_label()
library(haven)            # for read_spss()
library(lattice)          # For xyplot(), bwplot(), etc. 
library(psych)            # For describe()
library(car)              # For recode()
library(SSACHR)           # for rvlabel()
```

Create objects to hold settings we plan to reuse often. 

```{r my_settings}
# Custom settings for use with bwplot().
my.boxes <- list(box.rectangle = list(col = "black", lwd = 2), 
                 box.umbrella = list(col = "black", lwd = 2))
```

\FloatBarrier

# Load Data 
The chunk below loads the data saved by the prior script *Step_01_Data_Mgt.Rmd*.

```{r load_data}
load(file = here::here("./data/CHR_Data.RData"))
```

\FloatBarrier

# Offender-Level Summaries
We have few offender-level demographic variables that are worth reporting (we 
will omit summarizing height, weight, hair color, & eye color). After examining
sex, race, and age, we switch focus to looking at descriptive data about the 
criminal history records for arrests, prosecutor charges, and adjudicated 
charges. 

All the CHR summaries in this section focus on variables that have been 
aggregated to offender level. That is why the sample size for all of these
variables is N = `r nrow(IDNEW)` (the number of offenders for whom Michigan CHR 
data were available and the start date for the earliest SAK testing window could
be established). 

\FloatBarrier

## Sex
```{r examine_Sex}
kable(freq(as_factor(IDNEW$Sex)), format = "latex", booktabs = TRUE, digits = 2,
      caption = "Offender Sex")
```

\FloatBarrier

## Race
```{r examine_Race}
kable(freq(as_factor(IDNEW$Race), user.missing = "Unknown"), format = "latex", 
      booktabs = TRUE,  digits = 2, caption = "Offender Race")
```

\FloatBarrier

## Age (as of 04/15/2016)
```{r examine_Age, fig.height = 2}
CNums  <- c(2:4,8,9,11:12, 14:16)
CNames <- c("N", "Mean", "SD", "Min", "Max", "Skew", "Kurtosis", "Q25", "Q50", 
            "Q75")
Age <- describe(IDNEW$Age,  quant=c(.25, .50, .75))
kable(Age[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender Age (as of 04/15/2016)")
```

```{r boxplot_Age, fig.height = 1.75, fig.cap=FCap}
# Figure caption.
FCap <- paste("Box Plot for Offender Age. Only offenders with valid testing", 
              "window start dates are included.")

bwplot(~ Age, data = IDNEW, factor = 9, xlim = c(18, 82),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Offender Age (as of 04/15/2016)")
```

\FloatBarrier

## CHR Record Counts
We aggregated data to count how many CHR records of each type are associated 
with each offender. We summarize the resulting variables (*NINC*, *NARR*, 
*NCHG*, *NJUD*, & *NCON*) below. Table \ref{tab:describe_rcvars} provides 
overall descriptive statistics for all record types, plus summaries broken down
by when the associated incidents occurred relative to the testing window. 

```{r describe_rcvars}
# Table caption. 
TCap <- paste("Offender-Level Record Counts (All Crime Categories, Overall and",
              "By When Incident Occurred Relative to Testing Window)")
# Footnote text. 
FN <- paste("Only offenders with valid testing window start dates are included.",
            "Before, during, and after refer to when the incident associated",
            "with the record occurred, not when the arrest date, charge date,",
            "adjudication date, or conviction date occurred relative to the",
            "testing window.")

BDA <- c("...Before testing window", 
         "...During testing window", 
         "...After testing window")
rclabs <- c("No. of incidents", BDA, 
            "No. of arrest offenses", BDA,
            "No. of prosecutor charges", BDA,
            "No. of adjudicated charges (all)", BDA,
            "No. of adjudicated charges (convictions)", BDA)

# Summarize CHR record counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(NINC, NINC_Before, NINC_During, NINC_After, 
         NARR, NARR_Before, NARR_During, NARR_After,
         NCHG, NCHG_Before, NCHG_During, NCHG_After,
         NJUD, NJUD_Before, NJUD_During, NJUD_After,
         NCON, NCON_Before, NCON_During, NCON_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = rclabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = c("Variable", CNames), caption = TCap) %>% 
  group_rows(" ", 1, 4) %>% 
  group_rows(" ", 5, 8) %>% 
  group_rows(" ", 9, 12) %>% 
  group_rows(" ", 13, 16) %>% 
  group_rows(" ", 17, 20) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r create_RCCOUNTS}
# Vectors of variables names and labels. 
rcvars  <- c("NINC", "NARR", "NCHG", "NJUD", "NCON")
rctypes <- c("Incidents", "Arrest Offenses", "Prosecutor Charges", 
             "Adjudicated Charges", "Convictions")

IDNEW %>% 
  select(OID, NINC, NARR, NCHG, NJUD, NCON) %>% 
  # Rearrange data so we can easily plot multiple variables. 
  pivot_longer(cols = -OID, names_to = "VName", values_to = "Count") %>% 
  mutate(VName = ordered(VName, levels = rcvars, labels = rctypes)) ->
  RCCOUNTS
```

```{r boxplot_RCCOUNTS, fig.height = 3, fig.cap=FCap}
# Figure caption.
FCap <- paste("Box Plots for Overall Record Counts by Criminal History Record", 
              "Type. Only offenders with valid testing window start dates are", 
              "included.")

bwplot(VName ~ Count, data = RCCOUNTS, factor = 1, xlim = c(-4, 64),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Overall Number of Records for Individual Offender")
```

``` {r densityplot_RCCOUNTS, fig.height = 3, fig.width = 8.5, fig.cap=FCap}
# Figure caption.
FCap <- paste("Density Plots for Overall Record Counts by Criminal History", 
              "Record Type. Only offenders with valid testing window start", 
              "dates are included.")

densityplot(~ Count | VName, data = RCCOUNTS, layout = c(5,1), 
            panel = panel.mydensity, jitter.amount = 0.005,
            strip = strip.custom(par.strip.text = list(cex = .8)),
            xlab = "Overall Number of Records for Offender")
```

In the subsections below, Tables \ref{tab:freq_NINC}, \ref{tab:freq_NARR}, \ref{tab:freq_NCHG}, 
\ref{tab:freq_NJUD}, and \ref{tab:freq_NCON} respectively show the frequency 
distributions underlying those statistics for incidents, arrest offenses, 
prosecutor charges, all adjudicated charges, and adjudicated charges that were 
convictions. 

\FloatBarrier 

### Incident Records

```{r freq_NINC}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Incidents (All Crime",
              "Categories) Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NINC, NINC_Before, NINC_During, NINC_After) %>% 
  rename(All = NINC, Before = NINC_Before, During = NINC_During, 
         After = NINC_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Arrest Offense Records

```{r freq_NARR}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Arrest Offenses (All",
              "Crime Categories) Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the arrest date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "arrested during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NARR, NARR_Before, NARR_During, NARR_After) %>% 
  rename(All = NARR, Before = NARR_Before, During = NARR_During, 
         After = NARR_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Prosecutor Charge Records

```{r freq_NCHG}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Prosecutor Charges (All",
              "Crime Categories) Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "charged during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NCHG, NCHG_Before, NCHG_During, NCHG_After) %>% 
  rename(All = NCHG, Before = NCHG_Before, During = NCHG_During, 
         After = NCHG_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Adjudicated Charge Records (All)

```{r freq_NJUD}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Adjudicated Charges (All",
              "Crime Categories) Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the adjudication date occurred ",
            "relative to the testing window. For example, a charge could be ",
            "adjudicated during the testing window for an incident that ",
            "occurred before it began. That would show up here in the before ",
            "column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NJUD, NJUD_Before, NJUD_During, NJUD_After) %>% 
  rename(All = NJUD, Before = NJUD_Before, During = NJUD_During, 
         After = NJUD_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Adjudicated Charge Records (Convictions)

```{r freq_NCON}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Adjudicated Charges (All",
              "Crime Categories, Convictions) Overall and By When Incident",
              "Occurred")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the adjudication date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "convicted during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NCON, NCON_Before, NCON_During, NCON_After) %>% 
  rename(All = NCON, Before = NCON_Before, During = NCON_During, 
         After = NCON_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

## Crime Category Counts
Table \ref{tab:describe_cccvars} summarizes how many of 12 different categories
of crime each offender was *arrested for*, *charged with*, *convicted of*, and
*arrested for, charged with, or convicted of* according to the CHR data. This
sums a set of binary transforms on the incident count variables associated with
each crime category in *ACat12*, *CCat12*, and *JCat12*. The 
*Excluded user-missing* value is not counted as a category, so the possible
range of values for these counts is 0-12. We report both overall results, and
results broken down by when the incidents associated with the arrest, charge,
and conviction records occurred relative to the earliest testing window.

```{r describe_cccvars}
# Table caption. 
TCap <- paste("Offender-Level Crime Category Counts (Overall and By When",
              "Incident Occurred)")
# Footnote text. 
FN <- paste("Only offenders with valid testing window start dates are included.",
            "Before, during, and after refer to when the incident associated",
            "with the record occurred, not when the arrest date, charge date,",
            "adjudication date, or conviction date occurred relative to the",
            "testing window.")

cclabs <- c("No. of crime categories (arrested)", BDA, 
            "No. of crime categories (charged)", BDA,
            "No. of crime categories (convicted)", BDA,
            "No. of crime categories (arrested, charged, or convicted)", BDA)

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(ACat12_Count, ACat12_Count_Before, ACat12_Count_During, ACat12_Count_After, 
         CCat12_Count, CCat12_Count_Before, CCat12_Count_During, CCat12_Count_After,
         JCat12_Count, JCat12_Count_Before, JCat12_Count_During, JCat12_Count_After,
         HXCat12_Count, HXCat12_Count_Before, HXCat12_Count_During, HXCat12_Count_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = cclabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = c("Variable", CNames), caption = TCap) %>% 
  group_rows(" ", 1, 4) %>% 
  group_rows(" ", 5, 8) %>% 
  group_rows(" ", 9, 12) %>% 
  group_rows(" ", 13, 16) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

In the subsections below, Tables \ref{tab:freq_ACat12_Count}, 
\ref{tab:freq_CCat12_Count}, \ref{tab:freq_JCat12_Count}, and
\ref{tab:freq_HXCat12_Count} show the frequency distributions underlying the
summaries in Table \ref{tab:describe_cccvars}. 

\FloatBarrier

### Arrested

```{r freq_ACat12_Count}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Crime Categories for",
              "Which Offender Was Arrested (Overall and By When Incident",
              "Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the arrest date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "arrested during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, ACat12_Count, ACat12_Count_Before, ACat12_Count_During, 
         ACat12_Count_After) %>% 
  rename(All = ACat12_Count, Before = ACat12_Count_Before, 
         During = ACat12_Count_During, After = ACat12_Count_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Charged

```{r freq_CCat12_Count}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Crime Categories for",
              "Which Offender Was Charged (Overall and By When Incident",
              "Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "charged during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, CCat12_Count, CCat12_Count_Before, CCat12_Count_During, 
         CCat12_Count_After) %>% 
  rename(All = CCat12_Count, Before = CCat12_Count_Before, 
         During = CCat12_Count_During, After = CCat12_Count_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Convicted

```{r freq_JCat12_Count}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Crime Categories for",
              "Which Offender Was Convicted (Overall and By When Incident",
              "Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "convicted during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, JCat12_Count, JCat12_Count_Before, JCat12_Count_During, 
         JCat12_Count_After) %>% 
  rename(All = JCat12_Count, Before = JCat12_Count_Before, 
         During = JCat12_Count_During, After = JCat12_Count_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Arrested, Charged, or Convicted

```{r freq_HXCat12_Count}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Crime Categories for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall",
              "and By When Incident Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "convicted during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_Count, HXCat12_Count_Before, HXCat12_Count_During, 
         HXCat12_Count_After) %>% 
  rename(All = HXCat12_Count, Before = HXCat12_Count_Before, 
         During = HXCat12_Count_During, After = HXCat12_Count_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

## Incident Counts by Crime Category (12 levels)
In this section, we analyze variables that contain the number of unique 
incidents in the offender's criminal history for a given type of crime. We have 
four separate counts for each category of crime. The first three represent 
incidents where the offender was *arrested for*, *charged with*, or 
*convicted of* crimes classified into that category. We also include counts of
incidents based on a combined criterion where the offender was 
*arrested for, charged with, or convicted of* (any of the three events, or any 
combination of them) crimes classified into the relevant category.

Note that these variables were created by first aggregating ARR, CHG, and JUD 
records to the incident level to flag incidents that fit the relevant category, 
then aggregated again to get to the offender level incident counts. It is 
possible to have multiple arrest offense records, charge records, or 
adjudication records for convictions on a single incident, but these variables 
ignore that and only count each incident once. 

The chunk below creates some objects we use to dynamically construct text later 
in the subsections below. 

```{r create_History_Vars}
# Save a formatted value for total number of offenders.
N_IDNEW <- format(nrow(IDNEW), big.mark = ",")

# Check how many offenders had >= 1 CSC arrest, charge, or conviction in 
# their CHR data for each crime category.
IDNEW %>% filter(HXCat12_1  >= 1) %>% nrow() -> N_HXCat12_1
IDNEW %>% filter(HXCat12_2  >= 1) %>% nrow() -> N_HXCat12_2
IDNEW %>% filter(HXCat12_3  >= 1) %>% nrow() -> N_HXCat12_3
IDNEW %>% filter(HXCat12_4  >= 1) %>% nrow() -> N_HXCat12_4
IDNEW %>% filter(HXCat12_5  >= 1) %>% nrow() -> N_HXCat12_5
IDNEW %>% filter(HXCat12_6  >= 1) %>% nrow() -> N_HXCat12_6
IDNEW %>% filter(HXCat12_7  >= 1) %>% nrow() -> N_HXCat12_7
IDNEW %>% filter(HXCat12_8  >= 1) %>% nrow() -> N_HXCat12_8
IDNEW %>% filter(HXCat12_9  >= 1) %>% nrow() -> N_HXCat12_9
IDNEW %>% filter(HXCat12_10 >= 1) %>% nrow() -> N_HXCat12_10
IDNEW %>% filter(HXCat12_11 >= 1) %>% nrow() -> N_HXCat12_11
IDNEW %>% filter(HXCat12_12 >= 1) %>% nrow() -> N_HXCat12_12

# Convert those new variables to percentages. 
P_HXCat12_1  <- round(100*N_HXCat12_1/nrow(IDNEW), digits = 0)
P_HXCat12_2  <- round(100*N_HXCat12_2/nrow(IDNEW), digits = 0)
P_HXCat12_3  <- round(100*N_HXCat12_3/nrow(IDNEW), digits = 0)
P_HXCat12_4  <- round(100*N_HXCat12_4/nrow(IDNEW), digits = 0)
P_HXCat12_5  <- round(100*N_HXCat12_5/nrow(IDNEW), digits = 0)
P_HXCat12_6  <- round(100*N_HXCat12_6/nrow(IDNEW), digits = 0)
P_HXCat12_7  <- round(100*N_HXCat12_7/nrow(IDNEW), digits = 0)
P_HXCat12_8  <- round(100*N_HXCat12_8/nrow(IDNEW), digits = 0)
P_HXCat12_9  <- round(100*N_HXCat12_9/nrow(IDNEW), digits = 0)
P_HXCat12_10 <- round(100*N_HXCat12_10/nrow(IDNEW), digits = 0)
P_HXCat12_11 <- round(100*N_HXCat12_11/nrow(IDNEW), digits = 0)
P_HXCat12_12 <- round(100*N_HXCat12_12/nrow(IDNEW), digits = 0)
```

This next chunk creates some objects to store things like standardized footnotes
that we will re-use. 

```{r create_table_settings}
# Footnote text: Descriptives tables. 
FN1 <- paste("Only offenders with valid testing window start dates are",
             "included. Before, during, and after refer to when the incident",
             "associated with the record occurred, not when the arrest date,",
             "charge date, or conviction date occurred relative to the testing",
             "window.")

# Footnote text: Arrested frequencies.
FN2 <- paste0("N = ", N_IDNEW, ". TW, earliest testing window. Before, ",
              "during, and after refer to when the incident associated ",
              "with the record occurred, not when the arrest date occurred ",
              "relative to the testing window. For example, an offender could ",
              "be arrested during the testing window for an incident that ",
              "occurred before it began. That would show up here in the ",
              "before column.")

# Footnote text: Charged frequencies. 
FN3 <- paste0("N = ", N_IDNEW, ". TW, earliest testing window. Before, ",
              "during, and after refer to when the incident associated ",
              "with the record occurred, not when the charge date occurred ",
              "relative to the testing window. For example, an offender could ",
              "be charged during the testing window for an incident that ",
              "occurred before it began. That would show up here in the ",
              "before column.")

# Footnote text: Convicted frequencies. 
FN4 <- paste0("N = ", N_IDNEW, ". TW, earliest testing window. Before, ",
              "during, and after refer to when the incident associated ",
              "with the record occurred, not when the charge date occurred ",
              "relative to the testing window. For example, an offender could ",
              "be convicted during the testing window for an incident that ",
              "occurred before it began. That would show up here in the ",
              "before column.")

# Footnote text.
FN5 <- paste0("N = ", N_IDNEW, ". TW, earliest testing window. Before, ",
              "during, and after refer to when the incident associated ",
              "with the record occurred, not when the arrest, charge, or ",
              "conviction date occurred relative to the testing window. For ",
              "example, an offender could be arrested during the testing ",
              "window for an incident that occurred before it began. That ",
              "would show up here in the before column. ", 
              "An incident is counted if there are any arrest, charge, or ",
              "conviction records (any one type, or any combination of them ",
              "will suffice) for the specified crime category associated with ",
              "it.")

# Vector of count types
counttypes <- c("Arrested", "Charged", "Convicted", 
                "Arrested, Charged, or Convicted")

# Vector of row labels for descriptives tables. 
TRowLabs <- c("Incident count (arrested)", BDA, 
              "Incident count (charged)", BDA,
              "Incident count (convicted)", BDA,
              "Incident count (arrested, charged, or convicted)", BDA)
```

\FloatBarrier

### Arson 
Among these `r N_IDNEW` suspected sexual offenders, there were 
`r N_HXCat12_1` (`r P_HXCat12_1`\%) offenders who had criminal histories
containing at least one incident associated with an arson arrest, charge, or
conviction. Table \ref{tab:describe_arsonvars} summarizes the counts of unique
arson incidents by CHR record type and when the incident occurred. In the
subsections below, Tables \ref{tab:freq_ACat12_1}, \ref{tab:freq_CCat12_1},
\ref{tab:freq_JCat12_1}, and \ref{tab:freq_HXCat12_1} show the frequency
distributions underlying the summaries in Table \ref{tab:describe_arsonvars}.

```{r describe_arsonvars}
# Table caption. 
TCap <- paste("Offender-Level Arson Incident Counts By CHR Record Type (Overall",
              "and By When Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(ACat12_1, ACat12_1_Before, ACat12_1_During, ACat12_1_After, 
         CCat12_1, CCat12_1_Before, CCat12_1_During, CCat12_1_After, 
         JCat12_1, JCat12_1_Before, JCat12_1_During, JCat12_1_After,
         HXCat12_1, HXCat12_1_Before, HXCat12_1_During, HXCat12_1_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = c("Variable", CNames), caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Arrested
Table \ref{tab:freq_ACat12_1} shows the frequency distributions for arson
incidents for which the offender was arrested.  

```{r freq_ACat12_1}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Arson Incidents for Which",
              "Offender Was Arrested (Overall and By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, ACat12_1, ACat12_1_Before, ACat12_1_During, ACat12_1_After) %>% 
  rename(All = ACat12_1, Before = ACat12_1_Before, During = ACat12_1_During, 
         After = ACat12_1_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN2, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Charged
Table \ref{tab:freq_CCat12_1} shows the frequency distributions for arson
incidents for which the offender was charged.  

```{r freq_CCat12_1}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Arson Incidents for Which",
              " Offender Was Charged (Overall and By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, CCat12_1, CCat12_1_Before, CCat12_1_During, CCat12_1_After) %>% 
  rename(All = CCat12_1, Before = CCat12_1_Before, During = CCat12_1_During, 
         After = CCat12_1_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN3, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Convicted
Table \ref{tab:freq_JCat12_1} shows the frequency distributions for arson
incidents for which the offender was convicted.  


```{r freq_JCat12_1}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Arson Incidents for Which",
              "Offender Was Convicted (Overall and By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, JCat12_1, JCat12_1_Before, JCat12_1_During, JCat12_1_After) %>% 
  rename(All = JCat12_1, Before = JCat12_1_Before, During = JCat12_1_During, 
         After = JCat12_1_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN4, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Arrested, Charged, or Convicted
Table \ref{tab:freq_HXCat12_1} shows the frequency distributions for arson
incidents for which the offender was arrested, charged, or convicted.  

```{r freq_HXCat12_1}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Arson Incidents for Which",
              "Offender Was Arrested, Charged, or Convicted (Overall and By",
              "When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_1, HXCat12_1_Before, HXCat12_1_During, HXCat12_1_After) %>% 
  rename(All = HXCat12_1, Before = HXCat12_1_Before, During = HXCat12_1_During, 
         After = HXCat12_1_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```


```{r create_Arson_CHR_History}
# Check how many offenders had >= 1 CSC arrest, charge, or conviction in their CHR data. 
IDNEW %>% 
  filter(HXCat12_1 >= 1) %>% 
  nrow() -> 
  Arson_CHR_History
```

Among these `r format(nrow(IDNEW), big.mark = ",")` suspected sexual offenders, 
there were `r Arson_CHR_History` 
(`r round(100*Arson_CHR_History/nrow(IDNEW), digits = 0)`\%) offenders who had 
criminal histories containing at least one incident associated with an arson 
arrest, charge, or conviction. 

\FloatBarrier

### Assault - DV, Stalking 
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* assaults involving domestic
violence and/or stalking.

```{r}
ACat12_2 <- describe(IDNEW[, c("ACat12_2", "CCat12_2", "JCat12_2")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_2) <- RN.ACC
kable(ACat12_2[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Assault - DV, Stalking Incident Counts")
```

\FloatBarrier

### Assault - Non-Sexual, Non-DV 
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* assaults that were non-sexual
and did not involve domestic violence. 

```{r}
ACat12_3 <- describe(IDNEW[, c("ACat12_3", "CCat12_3", "JCat12_3")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_3) <- RN.ACC
kable(ACat12_3[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Assault - Non-Sexual, Non-DV Incident Counts")
```

\FloatBarrier

### Burglary 
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* burglary.

```{r}
ACat12_4 <- describe(IDNEW[, c("ACat12_4", "CCat12_4", "JCat12_4")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_4) <- RN.ACC
kable(ACat12_4[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Burglary Incident Counts")
```

\FloatBarrier

### Criminal Sexual Conduct
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* criminal sexual conduct. We 
also include counts of incidents based on a combined criterion where the 
offender was *arrested, charged, or convicted* (any of the three, or any 
combination of them) of criminal sexual conduct. 

```{r describe_cscvars}
# Table caption. 
TCap <- paste("Offender-Level Criminal Sexual Conduct Incidents (Overall and",
              "By When Incident Occurred)")
# Footnote text. 
FN <- paste("Only offenders with valid testing window start dates are included.",
            "Before, during, and after refer to when the incident associated",
            "with the record occurred, not when the arrest date, charge date,",
            "or conviction date occurred relative to the testing window.")

TRowLabs <- c("CSC incident count (arrested)", BDA, 
              "CSC incident count (charged)", BDA,
              "CSC incident count (convicted)", BDA,
              "CSC incident count (arrested, charged, or convicted)", BDA)

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(ACat12_5, ACat12_5_Before, ACat12_5_During, ACat12_5_After, 
         CCat12_5, CCat12_5_Before, CCat12_5_During, CCat12_5_After, 
         JCat12_5, JCat12_5_Before, JCat12_5_During, JCat12_5_After,
         HXCat12_5, HXCat12_5_Before, HXCat12_5_During, HXCat12_5_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = c("Variable", CNames), caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_ACat12_5}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Criminal Sexual Conduct",
              "Incidents for Which Offender Was Arrested (Overall and By When",
              "Incident Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the arrest date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "arrested during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, ACat12_5, ACat12_5_Before, ACat12_5_During, ACat12_5_After) %>% 
  rename(All = ACat12_5, Before = ACat12_5_Before, During = ACat12_5_During, 
         After = ACat12_5_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```


```{r freq_CCat12_5}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Criminal Sexual Conduct",
              "Incidents for Which Offender Was Charged (Overall and By When",
              "Incident Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "charged during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, CCat12_5, CCat12_5_Before, CCat12_5_During, CCat12_5_After) %>% 
  rename(All = CCat12_5, Before = CCat12_5_Before, During = CCat12_5_During, 
         After = CCat12_5_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_JCat12_5}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Criminal Sexual Conduct",
              "Incidents for Which Offender Was Convicted (Overall and By When",
              "Incident Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "convicted during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, JCat12_5, JCat12_5_Before, JCat12_5_During, JCat12_5_After) %>% 
  rename(All = JCat12_5, Before = JCat12_5_Before, During = JCat12_5_During, 
         After = JCat12_5_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_5}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Criminal Sexual Conduct",
              "Incidents for Which Offender Was Arrested, Charged, or",
              "Convicted (Overall and By When Incident Occurred)")
# Footnote text.
FN <- paste0("N = ", format(nrow(IDNEW), big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the arrest, charge, or ",
            "conviction date occurred relative to the testing window. For ",
            "example, an offender could be arrested during the testing window ",
            "for an incident that occurred before it began. That would show up",
            "here in the before column. ", 
            "An incident is counted as showing a criminal sexual conduct ",
            "history if there are any CSC arrest, charge, or conviction ",
            "records associated with it (any one type, or any combination of ",
            "them will suffice).")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_5, HXCat12_5_Before, HXCat12_5_During, HXCat12_5_After) %>% 
  rename(All = HXCat12_5, Before = HXCat12_5_Before, 
         During = HXCat12_5_During, After = HXCat12_5_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/nrow(IDNEW),
         Before_p = 100*Before/nrow(IDNEW),
         During_p = 100*During/nrow(IDNEW),
         After_p = 100*After/nrow(IDNEW)) %>% 
  select(Value, All, All_p, Before, Before_p, During, During_p, After, 
         After_p) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("Frequency", "Percent"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 2, "Before TW" = 2, "During TW" = 2,
                   "After TW" = 2)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r create_CSCCOUNTS, fig.height = 3, warning= FALSE}
# Vector of variables to plot. 
countvars  <- c("ACat12_5", "CCat12_5", "JCat12_5", "HXCat12_5")

IDNEW %>% 
  select(OID, ACat12_5, CCat12_5, JCat12_5, HXCat12_5) %>% 
  # Rearrange data so we can easily plot multiple variables. 
  pivot_longer(cols = -OID, names_to = "VName", values_to = "Count") %>%
  mutate(VName = ordered(VName, levels = countvars, labels = counttypes)) ->
  CSCCOUNTS
```  

```{r densityplot_CSCCOUNTS, fig.height = 3, fig.width = 8.5, fig.cap=FCap}
# Figure caption.
FCap <- paste("Density Plots for Overall Number of Incidents With Evidence of", 
              "Criminal Sexual Conduct by Criminal History Record Type.", 
              "Only offenders with valid testing window start dates are", 
              "included.")

densityplot(~ Count | VName, data = CSCCOUNTS, layout = c(4,1), 
            panel = panel.mydensity, jitter.amount = 0.1,
            strip = strip.custom(par.strip.text = list(cex = .7)),
            xlab = "Overall Number of Incidents with Criminal Sexual Conduct")
```

```{r create_CSC_CHR_History}
# Check how many offenders had >= 1 CSC arrest, charge, or conviction in their CHR data. 
IDNEW %>% 
  filter(HXCat12_5 >= 1) %>% 
  nrow() -> 
  CSC_CHR_History
```

Among these `r format(nrow(IDNEW), big.mark = ",")` suspected sexual offenders, 
there were `r CSC_CHR_History` 
(`r round(100*CSC_CHR_History/nrow(IDNEW), digits = 0)`\%) offenders who had 
criminal histories containing at least one incident associated with a CSC 
arrest, charge, or conviction. 

\FloatBarrier

### Drug Crime 
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* drug crimes.

```{r}
ACat12_6 <- describe(IDNEW[, c("ACat12_6", "CCat12_6", "JCat12_6")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_6) <- RN.ACC
kable(ACat12_6[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Drug Crime Incident Counts")
```

\FloatBarrier

### Homicide 
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* homicide.

```{r}
ACat12_7 <- describe(IDNEW[, c("ACat12_7", "CCat12_7", "JCat12_7")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_7) <- RN.ACC
kable(ACat12_7[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Homicide Incident Counts")
```

\FloatBarrier

### Larceny/Theft/Fraud 
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* larceny, theft, or fraud. 

```{r}
ACat12_8 <- describe(IDNEW[, c("ACat12_8", "CCat12_8", "JCat12_8")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_8) <- RN.ACC
kable(ACat12_8[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Larceny, Theft, or Fraud Incident Counts")
```

\FloatBarrier

### Robbery
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* robbery.

```{r}
ACat12_9 <- describe(IDNEW[, c("ACat12_9", "CCat12_9", "JCat12_9")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_9) <- RN.ACC
kable(ACat12_9[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Robbery Incident Counts")
```

\FloatBarrier

### Sex Crimes
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* sex crimes (excluding 
criminal sexual conduct).

```{r}
ACat12_10 <- describe(IDNEW[, c("ACat12_10", "CCat12_10", "JCat12_10")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_10) <- RN.ACC
kable(ACat12_10[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Sex Crime Incident Counts")
```

\FloatBarrier

### Traffic and Ordinances
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* traffic crimes and violations
of ordinances.

```{r}
ACat12_11 <- describe(IDNEW[, c("ACat12_11", "CCat12_11", "JCat12_11")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_11) <- RN.ACC
kable(ACat12_11[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Traffic and Ordinance Incident Counts")
```

\FloatBarrier

### Weapons
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* weapons crimes.

```{r}
ACat12_12 <- describe(IDNEW[, c("ACat12_12", "CCat12_12", "JCat12_12")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_12) <- RN.ACC
kable(ACat12_12[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Weapons Incident Counts")
```

\FloatBarrier

### Other Crimes (Excluded User-Missing)
Here we summarize the counts of unique incidents where the offender was 
*arrested for*, *charged with*, and *convicted of* any other type of crime not
included in the other tables above this section.

```{r}
ACat12_999 <- describe(IDNEW[, c("ACat12_999", "CCat12_999", "JCat12_999")], 
                  quant=c(.25, .50, .75))
row.names(ACat12_999) <- RN.ACC
kable(ACat12_999[, CNums], format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames,
      caption = "Offender-Level Other Crime (Excluded User-Missing) Incident Counts")
```

********************************************************************************
\FloatBarrier

# Arrest Offense Record Summaries
All summaries in this section directly summarize the ARR data without first 
aggregating to the incident or offender level. 

\FloatBarrier

## Crime Category (12 levels)
```{r}
kable(freq(as_factor(ARREW$ACat12), user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Arrest Offense Records by Crime Category (12 levels)")
```

\FloatBarrier

## Age at Arrest for Criminal Sexual Conduct
```{r describe_OAgeA}
# Table caption. 
TCap <- paste("Offender Age at Arrest for Criminal Sexual Conduct (Overall)")
# Footnote text. 
FN <- paste("This is an arrest offense record-level summary (offenders with",
            "multiple arrests contribute one age value per arrest record.",
            "Only arrest records for offenders with valid testing window start",
            "dates are included.")

ARREW %>% 
  filter(ACat12_5 == 1) %>% 
  select(OAgeA, ALag) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  filter(vars == 1) %>% 
  bind_cols(data.frame(Variable = "Age at arrest"), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = c("Variable", CNames), caption = TCap) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

********************************************************************************
\FloatBarrier

# Prosecutor Charge Record Summaries
All summaries in this section directly summarize the CHG data without first 
aggregating to the incident or offender level. 

\FloatBarrier

## Crime Category (12 levels)
```{r, fig.height = 2}
kable(freq(as_factor(CHGEW$CCat12), user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Prosecutor Charge Records by Crime Category (12 levels)")
```

********************************************************************************
\FloatBarrier

# Judicial Charge Record Summaries
All summaries in this section directly summarize the JUD data without first 
aggregating to the incident or offender level. Note that here we do not
distinguish between adjudicated charge records based on disposition. While
some of these records are convictions, others will have other dispositions.

\FloatBarrier

## Crime Category (12 levels, all dispositions)
```{r, fig.height = 2}
kable(freq(as_factor(JUDEW$JCat12), user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Adjudicated Charge Records (All Dispositions) by Crime Category (12 levels)")
```

\FloatBarrier

## Crime Category (12 levels, convictions)
```{r, fig.height = 2}
kable(freq(as_factor(JUDEW$JCat12[JUDEW$JDispCat == 1]), 
           user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Adjudicated Charge Records (Convictions Only) by Crime Category (12 levels)")
```

********************************************************************************
# Wrap Up

\FloatBarrier

## Project Information
These materials are scholarly products based on research funded by the following 
grant. 

Campbell, R., Pierce, S. J., & Sharma, D. (01/01/201512/31/2018). Serial sexual
assaults: A longitudinal examination of offending patterns using DNA evidence.
[NIJ Award # 2014-NE-BX-0006, Awarded, $699,533]. Sponsor: National Institute of
Justice. Location: Michigan State University, East Lansing, MI.

\FloatBarrier

## References
Campbell, R. (2019). *Serial sexual assaults: A longitudinal examination of
offending patterns using DNA evidence, Detroit, Michigan, 2009* [Data files,
codebooks, computer programs, and statistical output]. ICPSR37134-v1. Ann Arbor,
MI: Inter-university Consortium for Political and Social Research [distributor],
2019-02-28. Retrieved from: https://doi.org/10.3886/ICPSR37134.v1

\FloatBarrier

## Software Information
We use R Markdown to enhance reproducibility. Knitting the source R Markdown 
script *`r knitr:::current_input()`* generates this PDF file containing 
explanatory text, R code, plus R output (text and graphics).

- We used [RStudio](www.rstudio.org) `r rstudioapi::versionInfo()$version` to 
  work with R and R markdown files. The software chain looks like this:
  **Rmd file > RStudio > R > rmarkdown > knitr > pandoc > TinyTeX or MiKTeX > PDF file**.
- We recommend using [TinyTeX](https://yihui.org/tinytex/) to compile LaTeX files 
  into PDF files. However, it should be viable to use 
  [MiKTeX version 2.9](https://miktex.org) instead. 
- We used [pandoc](https://pandoc.org) `r pandoc_version()` for this 
  document. 

This document was generated using the following computational environment and 
dependencies: 

``` {r show_citations}
# If is_tineytex = TRUE, then we used TinyTex, otherwise we used MikTeX. 
tinytex:::is_tinytex()

# Get R and R package version numbers in use.
devtools::session_info()
```

The current Git commit details and status are:

```{r git_details, eval=TRUE}
# Store whether git2r is installed and we are in a git repository.
GitCheck <- "git2r" %in% installed.packages() & git2r::in_repository(path = ".")
cat(paste("GitCheck =", GitCheck, "\n"))

# What commit is this file at? 
if (GitCheck) git2r::repository(here::here())

# What is the repository status? 
if (GitCheck) git2r::status()
```
