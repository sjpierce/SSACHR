---
title: \sffamily{\bfseries{\LARGE Criminal History Records Paper Step 2 (Analysis)}}
geometry: "left=.5in,right=.5in,top=.75in,bottom=.75in"
author: "Steven J. Pierce"
output:
 pdf_document:
   latex_engine: xelatex
   number_sections: true
   toc: yes
   toc_depth: 4
   includes:
     in_header: "compact-title.tex"
urlcolor: blue
header-includes:
- \usepackage{fancyhdr}
- \usepackage[yyyymmdd,hhmmss]{datetime}
- \usepackage{lastpage}
- \usepackage{fontspec}
- \defaultfontfeatures{Ligatures=TeX}
- \usepackage[font={small}, margin=1cm, skip=2pt]{caption}
- \usepackage{url}
- \usepackage{floatrow}
- \floatplacement{figure}{!ht}
- \floatplacement{table}{!ht}
- \usepackage{placeins}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{dcolumn}
- \usepackage{titling}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \pretitle{\begin{center}\LARGE\bfseries}
- \posttitle{\end{center}}
- \pagestyle{fancy}
- \lhead{SSA CHR Paper Step 2 Analysis}
- \rhead{\today\ \currenttime}
- \lfoot{\texttt{\small \detokenize{`r sub(".Rmd", ".pdf", knitr:::current_input(dir = FALSE))`}}} 
- \cfoot{ }
- \fancyfoot[R]{\thepage\ of \pageref*{LastPage}}
- \renewcommand{\headrulewidth}{0.4pt}
- \renewcommand{\footrulewidth}{0.4pt}
- \fancypagestyle{plain}{\pagestyle{fancy}}
---

********************************************************************************  
\FloatBarrier

# Purpose
This file analyzes data derived from publicly archived data files (Campbell,
2019) to produce outputs for a descriptive paper about the criminal histories of
suspected serial sexual perpetrators.^[In this document, we use the terms
perpetrator and offender interchangeably. Both terms should be interpreted as
referring to individuals suspected of committing a crime but we occasionally
omit that qualifier for the sake of brevity.] The data come from Detroit, MI.

\FloatBarrier

# Setup
Set global R chunk options (local chunk options will over-ride global options). 
The method for creating a size option that controls font size in code chunks and
their text output is based on an answer to a question posted on   
[stackoverflow.com](https://stackoverflow.com/questions/25646333/code-chunk-font-size-in-rmarkdown-with-knitr-and-latex/46526740#46526740). 

``` {r global_options, cfsize = "footnotesize"}
# Create a custom chunk hook/option for controlling font size in chunk & output.
def.chunk.hook  <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(options$cfsize != "normalsize", paste0("\n \\", options$cfsize,"\n\n", 
                                              x, "\n\n \\normalsize"), x)
  })

# Global chunk options (over-ridden by local chunk options)
knitr::opts_chunk$set(include  = TRUE, echo = TRUE, error = TRUE, 
                      message = TRUE, warning = TRUE, cfsize = "footnotesize")

# Declare location of this script relative to the project root directory.
here::i_am(path = "inst/Step_02_Analysis.Rmd")
```

Load R packages that we need to get additional functions. 

``` {r load_packages}
library(here)             # for here()
library(plyr)             # For mapvalues()
library(dplyr)            # for %>%, filter(), group_by(), & summarise()
library(tidyr)            # for arrange(), filter(), group_by(), mutate(),  
                          # spread(), summarise(), %>%, etc. 
library(rmarkdown)        # for render()
library(knitr)            # for kable()
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)       # for kable_styling(), add_header_above(), column_spec(),
                          # collapse_rows(), and landscape()
library(descr)            # For freq().
options(descr.plot=FALSE) # Make freq() & crosstab() skip plots by default.
library(lubridate)        # For date conversion, eg. ymd(), time_length().
library(sjlabelled)       # For set_label(), get_label()
library(haven)            # for read_spss()
library(lattice)          # For xyplot(), bwplot(), etc. 
library(latticeExtra)     # for layer()
library(psych)            # For describe()
library(car)              # For recode()
library(SSACHR)           # for rvlabel()
library(geepack)          # for geeglm()
library(emmeans)          # for emmeans()
library(texreg)           # for texreg()
```

Create objects to hold settings we plan to reuse often. 

```{r my_settings}
# Custom settings for use with bwplot().
my.boxes <- list(box.rectangle = list(col = "black", lwd = 2), 
                 box.umbrella = list(col = "black", lwd = 2))
```

\FloatBarrier

# Load Data 
The chunk below loads the data saved by the prior script *Step_01_Data_Mgt.Rmd*.

```{r load_data}
load(file = here::here("./data/CHR_Data.RData"))
```

# Manage Data
The chunk below reorganizes the *IDNEW* data to a long person-period format with
three rows per offender (one row for each period before, during, and after the
testing window) and stores it as *IDNEWL*. The period (before, during, or after
the earliest testing window) is identified by the *When* variable. The observed
duration of the period is stored in *Years*, so *Years* > 0 indicates that the
period overlapped offender's observed adult CHR period for at least one day.
Meanwhile, *Years* = 0 indicates an unobserved period that did not overlap with
the offender's observed adult CHR period at all. We will use *IDNEWL* later for
running GEE models.

```{r create_IDNEWL}
IDNEW %>% 
  select(OID, Years_Before, Years_During, Years_After,
         HXCat12_Any_Before, HXCat12_Any_During, HXCat12_Any_After,
         HXCat12_Count_Before, HXCat12_Count_During, HXCat12_Count_After,
         HXCat12_1_Before, HXCat12_1_During, HXCat12_1_After,
         HXCat12_2_Before, HXCat12_2_During, HXCat12_2_After,
         HXCat12_3_Before, HXCat12_3_During, HXCat12_3_After,
         HXCat12_4_Before, HXCat12_4_During, HXCat12_4_After,
         HXCat12_5_Before, HXCat12_5_During, HXCat12_5_After,
         HXCat12_6_Before, HXCat12_6_During, HXCat12_6_After,
         HXCat12_7_Before, HXCat12_7_During, HXCat12_7_After,
         HXCat12_8_Before, HXCat12_8_During, HXCat12_8_After,
         HXCat12_9_Before, HXCat12_9_During, HXCat12_9_After,
         HXCat12_10_Before, HXCat12_10_During, HXCat12_10_After,
         HXCat12_11_Before, HXCat12_11_During, HXCat12_11_After,
         HXCat12_12_Before, HXCat12_12_During, HXCat12_12_After) %>% 
  pivot_longer(cols = -OID, names_to = c(".value", "When"), 
               names_pattern = "(.*)_(.*)",
               values_to = c("Duration", "HXCat12_Any", "HXCat12_Count", 
                             "HXCat12_1", "HXCat12_2", "HXCat12_3", 
                             "HXCat12_4", "HXCat12_5", "HXCat12_6", 
                             "HXCat12_7", "HXCat12_8", "HXCat12_9",
                             "HXCat12_10", "HXCat12_11", "HXCat12_12")) %>% 
  rename(NINC12 = HXCat12_Any) %>% 
  mutate(When = factor(x = When, levels = c("After", "Before", "During"))) ->
  IDNEWL
```

\FloatBarrier

# Offender-Level Summaries
We have few offender-level demographic variables that are worth reporting (we 
will omit summarizing height, weight, hair color, & eye color). After examining
sex, race, and age, we switch focus to looking at descriptive data about the 
criminal history records for arrests, prosecutor charges, and adjudicated 
charges. 

```{r sample_sizes}
# Store objects with sample sizes we will reuse often later. 
N_All    <- IDNEW %>% nrow()
N_Before <- IDNEW %>% filter(Years_Before > 0) %>% nrow()
N_During <- IDNEW %>% filter(Years_During > 0) %>% nrow()
N_After  <- IDNEW %>% filter(Years_After > 0) %>% nrow()
```

All the CHR summaries in this section focus on variables that have been 
aggregated to the offender level. That is why the sample size for all of these
variables is N = `r N_All` (the number of offenders for whom Michigan CHR 
data were available and the start date for the earliest SAK testing window could
be established). 

\FloatBarrier

## Sex

```{r examine_Sex}
kable(freq(as_factor(IDNEW$Sex)), format = "latex", booktabs = TRUE, digits = 2,
      caption = "Offender Sex")
```

\FloatBarrier

## Race

```{r examine_Race}
kable(freq(as_factor(IDNEW$Race), user.missing = "Unknown"), format = "latex", 
      booktabs = TRUE,  digits = 2, caption = "Offender Race")
```

\FloatBarrier

## Age
Table \ref{tab:examine_Age} presents descriptive statistics for offender 
age at the start of the earliest testing window and at the time of CHR 
collection. Figure \ref{fig:boxplot_Age} shows boxplots of the distributions 
for both of these age variables. 

```{r examine_Age, fig.height = 2}
CNames <- c("Variable", "N", "Mean", "SD", "Min", "Max", "Skew", "Kurtosis", 
            "Q25", "Q50", "Q75")
IDNEW %>% 
  select(AgeWDate, Age) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  mutate(Variable  = c("Age at earliest SAK", "Age at CHR collection")) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, 
         Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, 
      col.names = CNames, row.names = FALSE,
      caption = "Offender Age")
```

```{r boxplot_Age, fig.height = 2.5, fig.width = 7, fig.cap=FCap}
# Figure caption.
FCap <- paste("\\label{fig:boxplot_Age}",
              "Box Plots for Offender Age. Only offenders with valid testing", 
              "window start dates are included. The red line marks age 16",
              "years (the start of observed adult CHR data). CHR collection",
              "occurred on 04/15/2016 for all offfenders.",
              "CHR, criminal history record; SAK, sexual assault kit.")

IDNEW %>% 
  select(OID, AgeWDate, Age) %>% 
  # Rearrange data so we can easily plot multiple variables. 
  pivot_longer(cols = -OID, names_to = "VName", values_to = "Age") %>% 
  mutate(VName = ordered(VName, levels = c("AgeWDate", "Age"), 
                         labels = c("At earliest SAK", "At CHR collection"))) %>%
  bwplot(VName ~ Age, data = ., factor = 1, xlim = c(-2, 82),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Offender Age")  + 
  layer(panel.abline(v = 16, col.line = "red"))
```

\FloatBarrier

## CHR Periods
The observed portions of these offenders' adult criminal histories include 
incident, arrest, prosecutor charge, and judicial charge records associated with
crimes that occurred between the offender's 16th birthday and April 15, 2016
(when the CHR data were collected from the official statewide CHR database). 
That time frame can be divided into three important periods for the purposes of
this study: before, during, and after the testing window associated with the 
offender's earliest sexual assault kit (SAK). Here we provide descriptive data 
about those periods. Note that the relative timing of an offender's earliest SAK
relative to their 16th birthday controls how much of the before and during
periods were observed versus unobserved. Figures \ref{fig:boxplot_Age16Date} and 
\ref{fig:boxplot_WDate} respectively show boxplots for the date of the offenders
16th birthday and the start date of the earliest testing window (which is the 
date the earliest SAK was collected). 

```{r boxplot_Age16Date, fig.height = 1.75, fig.width = 7, fig.cap=FCap}
# Figure caption.
FCap <- paste("\\label{fig:boxplot_Age16Date}",
              "Box Plot for Date of Offender's 16th Birthday. Only offenders", 
              "with valid testing window start dates are included.",
              "These dates mark the start of the observed adult criminal",
              "history record for each offender.")

bwplot(~ Age16Date, data = IDNEW, factor = 9, 
       xlim = c(ymd("1948-01-01"), ymd("2012-12-31")),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Offender's 16th Birthday")
```

```{r boxplot_WDate, fig.height = 1.75, fig.width = 7, fig.cap=FCap}
# Figure caption.
FCap <- paste("\\label{fig:boxplot_WDate}",
              "Box Plot for Start Date of Earliest Testing Window. Only", 
              "offenders with valid testing window start dates are included.")

bwplot(~ WDate, data = IDNEW, factor = 9, 
       xlim = c(ymd("1984-01-01"), ymd("2016-12-31")),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Start of Earliest Testing Window")
```

Those dates were used in the previous data management script to compute the 
durations of the observed portions of adult CHR that correspond to the periods 
before, during, and after the earliest testing window. Table
\ref{tab:describe_windows} shows descriptive statistics for the these durations
and \ref{fig:boxplot_windows} shows corresponding boxplots. These provide 
crucial context for interpreting the numbers of crimes observed in each of those 
periods and provide the denominators for translating them into incidence rates. 

```{r describe_windows}
# Table caption.
TCap <- paste("Observed Period Durations (Years)")
# Footnote text.
FN <- paste0("Only offenders with valid testing window start dates are ", 
             "included. ",
             "TW, earliest testing window.")

rlabs <- c("Before TW", "During TW", "After TW")

IDNEW %>% 
  select(Years_Before, Years_During, Years_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = rlabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE,
      col.names = CNames, caption = TCap) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r boxplot_windows, fig.height = 2.5, fig.width = 7, fig.cap=FCap}
# Figure caption.
FCap <- paste("\\label{fig:boxplot_windows}",
              "Box Plots for Duration of Observed Portions of Periods.",
              "Only offenders with valid testing", 
              "window start dates are included. The red line marks age 16",
              "years, which is the start of observed adult CHR, which was ",
              "collected on 04/15/2016.",
              "TW, earliest testing window.")

IDNEW %>% 
  select(OID, Years_Before, Years_During, Years_After) %>% 
  # Rearrange data so we can easily plot multiple variables. 
  pivot_longer(cols = -OID, names_to = "VName", values_to = "Duration") %>% 
  mutate(VName = ordered(VName, 
                         levels = rev(c("Years_Before", "Years_During",
                                        "Years_After")), 
                         labels = rev(rlabs))) %>%
  bwplot(VName ~ Duration, data = ., factor = 1, xlim = c(-2, 42),
       panel = panel.mybox, par.settings = my.boxes, 
       xlab = "Observed Period Duration (Years)")
```

## CHR Record Counts
We aggregated data to count how many CHR records of each type are associated
with each offender. Here we are counting only records associated with incidents
for which the offender was arrested for, charged with, or convicted of at least
one offense from the 12 main crime categories. We summarize the resulting
variables (*NINC12*, *NARR12*, *NCHG12*, *NJUD12*, & *NCON12*) below. Table
\ref{tab:describe_rcvars} provides overall descriptive statistics for all record
types, plus summaries broken down by when the associated incidents occurred
relative to the testing window.

```{r describe_rcvars}
# Table caption. 
TCap <- paste("Offender-Level Record Counts (All Crime Categories, Overall and",
              "By When Incident Occurred Relative to Testing Window)")
# Footnote text. 
FN <- paste("Only offenders with valid testing window start dates are included.",
            "Only records associated with incidents where the offender was",
            "arrested for, charged with, or convicted of at least one offense",
            "from one of the 12 main crime categories were counted.",
            "Before, during, and after refer to when the incident associated",
            "with the record occurred, not when the arrest date, charge date,",
            "adjudication date, or conviction date occurred relative to the",
            "testing window.")

BDA <- c("...Before testing window", 
         "...During testing window", 
         "...After testing window")
rclabs <- c("No. of incidents", BDA, 
            "No. of arrest offenses", BDA,
            "No. of prosecutor charges", BDA,
            "No. of adjudicated charges (all)", BDA,
            "No. of adjudicated charges (convictions)", BDA)

# Summarize CHR record counts (both overall and broken down by IWhen).
IDNEW %>% 
  rename(NINC12 = HXCat12_Any, NINC12_Before = HXCat12_Any_Before, 
         NINC12_During = HXCat12_Any_During, NINC12_After = HXCat12_Any_After) %>% 
  select(NINC12, NINC12_Before, NINC12_During, NINC12_After, 
         NARR12, NARR12_Before, NARR12_During, NARR12_After,
         NCHG12, NCHG12_Before, NCHG12_During, NCHG12_After,
         NJUD12, NJUD12_Before, NJUD12_During, NJUD12_After,
         NCON12, NCON12_Before, NCON12_During, NCON12_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = rclabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap) %>% 
  group_rows(" ", 1, 4) %>% 
  group_rows(" ", 5, 8) %>% 
  group_rows(" ", 9, 12) %>% 
  group_rows(" ", 13, 16) %>% 
  group_rows(" ", 17, 20) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r create_RCCOUNTS}
# Vectors of variables names and labels. 
rcvars  <- c("NINC12", "NARR12", "NCHG12", "NJUD12", "NCON12")
rctypes <- c("Incidents", "Arrest Offenses", "Prosecutor Charges", 
             "Adjudicated Charges", "Convictions")

IDNEW %>% 
  rename(NINC12 = HXCat12_Any) %>% 
  select(OID, NINC12, NARR12, NCHG12, NJUD12, NCON12) %>% 
  # Rearrange data so we can easily plot multiple variables. 
  pivot_longer(cols = -OID, names_to = "VName", values_to = "Count") %>% 
  mutate(VName = ordered(VName, levels = rcvars, labels = rctypes)) ->
  RCCOUNTS
```

```{r boxplot_RCCOUNTS, fig.height = 3, fig.width = 7, fig.cap=FCap}
# Figure caption.
FCap <- paste("\\label{fig:boxplot_RCCOUNTS}",
              "Box Plots for Overall Record Counts by Criminal History Record", 
              "Type. Only offenders with valid testing window start dates are", 
              "included.",
              "Only records associated with incidents where the offender was",
              "arrested for, charged with, or convicted of at least one offense",
              "from one of the 12 main crime categories were counted.")

bwplot(VName ~ Count, data = RCCOUNTS, factor = 1, xlim = c(-4, 64),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Overall Number of Records for Individual Offender")
```

``` {r densityplot_RCCOUNTS, fig.height = 3, fig.width = 8.5, fig.cap=FCap}
# Figure caption.
FCap <- paste("\\label{fig:densityplot_RCCOUNTS}",
              "Density Plots for Overall Record Counts by Criminal History", 
              "Record Type. Only offenders with valid testing window start", 
              "dates are included.",
              "Only records associated with incidents where the offender was",
              "arrested for, charged with, or convicted of at least one offense",
              "from one of the 12 main crime categories were counted.", 
              "Dashed red lines are normal distribution curves (for comparison).")

densityplot(~ Count | VName, data = RCCOUNTS, layout = c(5,1), 
            panel = panel.mydensity, jitter.amount = 0.005,
            strip = strip.custom(par.strip.text = list(cex = .8)),
            xlab = "Overall Number of Records for Offender")
```

In the subsections below, Tables \ref{tab:freq_NINC}, \ref{tab:freq_NARR}, 
\ref{tab:freq_NCHG}, \ref{tab:freq_NJUD}, and \ref{tab:freq_NCON} respectively 
show the frequency distributions underlying those statistics for incidents,
arrest offenses, prosecutor charges, all adjudicated charges, and adjudicated
charges that were convictions.

\FloatBarrier 

### Incident Records

```{r freq_NINC}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Incidents",
              "Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("Only offenders with valid testing window start dates are ", 
             "included. Only incidents where the offender was arrested for, ",
             "charged with, or convicted of at least one offense from one of ",
             "the 12 main crime categories were included. ",
             "N = ", format(N_All, big.mark = ","), ". TW, earliest ",
             "testing window.")

# Get frequency distributions. 
IDNEW %>% 
  rename(NINC12 = HXCat12_Any, NINC12_Before = HXCat12_Any_Before, 
         NINC12_During = HXCat12_Any_During, NINC12_After = HXCat12_Any_After) %>% 
  select(OID, NINC12, NINC12_Before, NINC12_During, NINC12_After) %>% 
  rename(All = NINC12, Before = NINC12_Before, During = NINC12_During, 
         After = NINC12_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Arrest Offense Records

```{r freq_NARR}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Arrest Offenses (All",
              "Crime Categories) Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("N = ", format(N_All, big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Only arrest records for offenders with valid testing window start ",
            "dates and with offenses from the 12 main crime categories were ",
            "included. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the arrest date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "arrested during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NARR12, NARR12_Before, NARR12_During, NARR12_After) %>% 
  rename(All = NARR12, Before = NARR12_Before, During = NARR12_During, 
         After = NARR12_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>%
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Prosecutor Charge Records

```{r freq_NCHG}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Prosecutor Charges (All",
              "Crime Categories) Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("N = ", format(N_All, big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Only charge records for offenders with valid testing window start ",
            "dates and with charges from the 12 main crime categories were ",
            "included. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "charged during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NCHG12, NCHG12_Before, NCHG12_During, NCHG12_After) %>% 
  rename(All = NCHG12, Before = NCHG12_Before, During = NCHG12_During, 
         After = NCHG12_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>%
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%  
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Adjudicated Charge Records (All)

```{r freq_NJUD}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Adjudicated Charges (All",
              "Crime Categories) Overall and By When Incident Occurred")
# Footnote text.
FN <- paste0("N = ", format(N_All, big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Only records for offenders with valid testing window start dates ",
            "and with charges from one of the 12 main crime categories were ",
            "included. ", 
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the adjudication date occurred ",
            "relative to the testing window. For example, a charge could be ",
            "adjudicated during the testing window for an incident that ",
            "occurred before it began. That would show up here in the before ",
            "column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NJUD12, NJUD12_Before, NJUD12_During, NJUD12_After) %>% 
  rename(All = NJUD12, Before = NJUD12_Before, During = NJUD12_During, 
         After = NJUD12_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

### Adjudicated Charge Records (Convictions)

```{r freq_NCON}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Adjudicated Charges (All",
              "Crime Categories, Convictions) Overall and By When Incident",
              "Occurred")
# Footnote text.
FN <- paste0("N = ", format(N_All, big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Only conviction records for offenders with valid testing window ",
            "start dates and with charges from one of the 12 main crime ",
            "categories were included. ", 
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the adjudication date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "convicted during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, NCON12, NCON12_Before, NCON12_During, NCON12_After) %>% 
  rename(All = NCON12, Before = NCON12_Before, During = NCON12_During, 
         After = NCON12_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

## Crime Category Counts (Arrested, Charged, or Convicted)
Table \ref{tab:describe_cccvars} summarizes how many of 12 different crime 
categories each offender was *arrested for, charged with, or convicted of*
according to the CHR data. This sums a set of binary transforms on the incident
count variables associated with each crime category in *HXCat12*. It is possible
to have multiple arrest offense records, charge records, or conviction records 
for a specific category, but we only count each distinct category once at most.
The *Excluded user-missing* value is not counted as a category, so the possible
range of values for these counts is 0-12. We report both overall results, and
results broken down by when the incidents associated with the arrest, charge,
and conviction records occurred relative to the earliest testing window. Table \ref{tab:freq_HXCat12_Count} shows the frequency distributions underlying those
summaries. 

```{r describe_cccvars}
# Table caption. 
TCap <- paste("Offender-Level Crime Category Counts (Overall and By When",
              "Incident Occurred)")
# Footnote text. 
FN <- paste("Only offenders with valid testing window start dates are included.",
            "Only records associated with incidents where the offender was ",
            "arrested for, charged with, or convicted of at least one offense ",
            "from one of the 12 main crime categories were counted. ",
            "Before, during, and after refer to when the incident associated",
            "with the record occurred, not when the arrest date, charge date,",
            "adjudication date, or conviction date occurred relative to the",
            "testing window.")

cclabs <- c("No. of crime categories (arrested, charged, or convicted)", BDA)

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_Count, HXCat12_Count_Before, HXCat12_Count_During, 
         HXCat12_Count_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = cclabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_Count}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Crime Categories for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall",
              "and By When Incident Occurred)")
# Footnote text.
FN <- paste0("N = ", format(N_All, big.mark = ","), ". TW, earliest ",
            "testing window. ",
            "Only records associated with incidents where the offender was ",
            "arrested for, charged with, or convicted of at least one offense ",
            "from one of the 12 main crime categories were counted. ",
            "Before, during, and after refer to when the incident associated ",
            "with the record occurred, not when the charge date occurred ",
            "relative to the testing window. For example, an offender could be ",
            "convicted during the testing window for an incident that occurred ",
            "before it began. That would show up here in the before column.")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_Count, HXCat12_Count_Before, HXCat12_Count_During, 
         HXCat12_Count_After) %>% 
  rename(All = HXCat12_Count, Before = HXCat12_Count_Before, 
         During = HXCat12_Count_During, After = HXCat12_Count_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### GEE Models
To more closely examine the crime category counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r cccvar_gee}
cccvar_gee1 <- IDNEWL %>% 
  # Keep only observations for observed periods (i.e., those with Years > 0).
  filter(Years > 0) %>%
  geeglm(HXCat12_Count ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

cccvar_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_Count ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:cccvar_texreg} below shows the parameter estimates for both GEE
models. 

```{r cccvar_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Crime Category Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference level for When was the period after the testing",
             "window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(cccvar_gee1, cccvar_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:cccvar_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

### Estimated Marginal Means
Table \ref{tab:cccvar_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r cccvar_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Crime Category Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

cccvar_emmeans1 <- emmeans(cccvar_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
cccvar_emmeans2 <- emmeans(cccvar_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(cccvar_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(cccvar_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:cccvar_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r cccvar_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Crime",
              "Category Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(cccvar_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(cccvar_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

## Incident Counts by Crime Category (12 levels)
In this section, we analyze variables that contain the number of unique 
incidents in the offender's criminal history for a given type of crime. For each
category of crime, we report include counts of incidents based on a combined 
criterion where the offender was *arrested for, charged with, or convicted of* 
(any of the three events, or any combination of them) crimes classified into the
relevant category.

Note that these variables were created by first aggregating *ARR*, *CHG*, and
*JUD* records to the incident level to flag incidents that fit the relevant
category, then aggregated again to get to the offender level incident counts. It
is possible to have multiple arrest offense records, charge records, or
adjudication records for convictions on a single incident, but these variables
ignore that and only count each incident once.

The chunk below creates some objects we use to dynamically construct text later 
in the subsections below. 

```{r create_History_Vars}
# Save a formatted value for total number of offenders.
N_IDNEW <- format(N_All, big.mark = ",")

# Check how many offenders had >= 1 CSC arrest, charge, or conviction in 
# their CHR data for each crime category.
IDNEW %>% filter(HXCat12_1  >= 1) %>% nrow() -> N_HXCat12_1
IDNEW %>% filter(HXCat12_2  >= 1) %>% nrow() -> N_HXCat12_2
IDNEW %>% filter(HXCat12_3  >= 1) %>% nrow() -> N_HXCat12_3
IDNEW %>% filter(HXCat12_4  >= 1) %>% nrow() -> N_HXCat12_4
IDNEW %>% filter(HXCat12_5  >= 1) %>% nrow() -> N_HXCat12_5
IDNEW %>% filter(HXCat12_6  >= 1) %>% nrow() -> N_HXCat12_6
IDNEW %>% filter(HXCat12_7  >= 1) %>% nrow() -> N_HXCat12_7
IDNEW %>% filter(HXCat12_8  >= 1) %>% nrow() -> N_HXCat12_8
IDNEW %>% filter(HXCat12_9  >= 1) %>% nrow() -> N_HXCat12_9
IDNEW %>% filter(HXCat12_10 >= 1) %>% nrow() -> N_HXCat12_10
IDNEW %>% filter(HXCat12_11 >= 1) %>% nrow() -> N_HXCat12_11
IDNEW %>% filter(HXCat12_12 >= 1) %>% nrow() -> N_HXCat12_12

# Convert those new variables to percentages. 
P_HXCat12_1  <- round(100*N_HXCat12_1/N_All, digits = 0)
P_HXCat12_2  <- round(100*N_HXCat12_2/N_All, digits = 0)
P_HXCat12_3  <- round(100*N_HXCat12_3/N_All, digits = 0)
P_HXCat12_4  <- round(100*N_HXCat12_4/N_All, digits = 0)
P_HXCat12_5  <- round(100*N_HXCat12_5/N_All, digits = 0)
P_HXCat12_6  <- round(100*N_HXCat12_6/N_All, digits = 0)
P_HXCat12_7  <- round(100*N_HXCat12_7/N_All, digits = 0)
P_HXCat12_8  <- round(100*N_HXCat12_8/N_All, digits = 0)
P_HXCat12_9  <- round(100*N_HXCat12_9/N_All, digits = 0)
P_HXCat12_10 <- round(100*N_HXCat12_10/N_All, digits = 0)
P_HXCat12_11 <- round(100*N_HXCat12_11/N_All, digits = 0)
P_HXCat12_12 <- round(100*N_HXCat12_12/N_All, digits = 0)
```

This next chunk creates some objects to store things like standardized footnotes
that we will re-use. 

```{r create_table_settings}
# Footnote text: Descriptives tables. 
FN1 <- paste("Only offenders with valid testing window start dates are",
             "included.",
             "Only incidents where the offender was arrested for, charged with,",
             "or convicted of at least one offense from one of the 12 main crime",
             "categories were counted.",
             "Before, during, and after refer to when the incident",
             "associated with the record occurred, not when the arrest date,",
             "charge date, or conviction date occurred relative to the testing",
             "window.")

# Footnote text.
FN5 <- paste0("N = ", N_IDNEW, ". TW, earliest testing window. ",
              "Only offenders with valid testing window start dates are ",
              "included. Before, during, and after refer to when the incident ",
              "associated with the record occurred, not when the arrest, ",
              "charge, or conviction date occurred relative to the testing ",
              "window. For example, an offender could be arrested during the ",
              "testing window for an incident that occurred before it began. ",
              "That would show up here in the before column. ", 
              "An incident is counted if there are any arrest, charge, or ",
              "conviction records (any one type, or any combination of them ",
              "will suffice) for the specified crime category associated with ",
              "it.")

# Vector of count types
counttypes <- c("Arrested", "Charged", "Convicted", 
                "Arrested, Charged, or Convicted")

# Vector of row labels for descriptives tables. 
TRowLabs <- c("Incident count (arrested, charged, or convicted)", BDA)
```

\FloatBarrier

### Arson 
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_1`
(`r P_HXCat12_1`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for arson. Table
\ref{tab:describe_arson} summarizes the counts of unique arson incidents 
overall and by when the incident occurred, while Table \ref{tab:freq_HXCat12_1} 
shows the frequency distributions underlying those summaries.

```{r describe_arson}
# Table caption. 
TCap <- paste("Offender-Level Arson Incident Counts (Overall and By When",
              "Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_1, HXCat12_1_Before, HXCat12_1_During, HXCat12_1_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_1}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Arson Incidents for Which",
              "Offender Was Arrested, Charged, or Convicted (Overall and By",
              "When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_1, HXCat12_1_Before, HXCat12_1_During, HXCat12_1_After) %>% 
  rename(All = HXCat12_1, Before = HXCat12_1_Before, During = HXCat12_1_During, 
         After = HXCat12_1_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>% 
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the arson incident counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_1_gee}
HXCat12_1_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_1 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_1_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_1 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_1_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_1_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Arson Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_1_gee1, HXCat12_1_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_1_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_1_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_1_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Arson Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_1_emmeans1 <- emmeans(HXCat12_1_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_1_emmeans2 <- emmeans(HXCat12_1_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_1_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_1_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_1_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_1_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Arson",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_1_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_1_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Assault - DV, Stalking 
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_2`
(`r P_HXCat12_2`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for assault involving
domestic violence and/or stalking. Table \ref{tab:describe_assaultdv}
summarizes the counts of unique assault incidents overall and by when the
incident occurred, while Table \ref{tab:freq_HXCat12_2} shows the frequency
distributions underlying those summaries.

```{r describe_assaultdv}
# Table caption. 
TCap <- paste("Offender-Level Assault Involving Domestc Violence and/or",
              "Stalking Incident Counts (Overall and By When Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_2, HXCat12_2_Before, HXCat12_2_During, HXCat12_2_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_2}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Assault Involving",
              "Domestic Violence and/or Stalking Incidents for Which",
              "Offender Was Arrested, Charged, or Convicted (Overall and By",
              "When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_2, HXCat12_2_Before, HXCat12_2_During, HXCat12_2_After) %>% 
  rename(All = HXCat12_2, Before = HXCat12_2_Before, During = HXCat12_2_During, 
         After = HXCat12_2_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### GEE Models
To more closely examine the assault involving domestic violence and/or stalking
incident counts, we fitted two generalized estimating equation (GEE) models to
the long-format *IDNEWL* data, after dropping rows for unobserved periods
(*Years* = 0) because the counts are missing for those observations.

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_2_gee}
HXCat12_2_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_2 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_2_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_2 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_2_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_2_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Assault Involving",
              "Domestic Violence and/or Stalking Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_2_gee1, HXCat12_2_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_2_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_2_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_2_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Assault Involving Domestic Violenace and/or",
              "Stalking Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_2_emmeans1 <- emmeans(HXCat12_2_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_2_emmeans2 <- emmeans(HXCat12_2_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_2_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_2_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_2_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_2_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Assault",
              "Involving Domestic Violence and/or Stalking",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_2_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_2_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Assault - Non-Sexual, Non-DV 
Among these `r N_IDNEW` suspected sexual offenders, there were 
`r N_HXCat12_3` (`r P_HXCat12_3`\%) offenders who had criminal histories
containing at least one incident associated with an arrest, charge, or 
conviction for a non-sexual, non-domestic violence assault. Table 
\ref{tab:describe_assaultndv} summarizes the counts of unique assault incidents
overall and by when the incident occurred, while Table \ref{tab:freq_HXCat12_3}
shows the frequency distributions underlying those summaries.

```{r describe_assaultndv}
# Table caption. 
TCap <- paste("Offender-Level Assault (Non-Sexual, Non-Domestic Violence)",
              "Incident Counts (Overall and By When Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_3, HXCat12_3_Before, HXCat12_3_During, HXCat12_3_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_3}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Assault (Non-Sexual,", 
              "Non-Domestic Violence) Incidents for Which Offender Was",
              "Arrested, Charged, or Convicted (Overall and By When Incident",
              "Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_3, HXCat12_3_Before, HXCat12_3_During, HXCat12_3_After) %>% 
  rename(All = HXCat12_3, Before = HXCat12_3_Before, During = HXCat12_3_During, 
         After = HXCat12_3_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the assault (non-sexual, non-domestic violence) incident
counts, we fitted two generalized estimating equation (GEE) models to the
long-format *IDNEWL* data, after dropping rows for unobserved periods (*Years* =
0) because the counts are missing for those observations.

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_3_gee}
HXCat12_3_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_3 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_3_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_3 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_3_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_3_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Assault (Non-Sexual,",
              "Non-Domestic Violance) Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_3_gee1, HXCat12_3_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_3_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_3_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_3_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Assault (Non-Sexual, Non-Domestic Violence)",
              "Incident Counts and Incidence Rates By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_3_emmeans1 <- emmeans(HXCat12_3_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_3_emmeans2 <- emmeans(HXCat12_3_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_3_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_3_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_3_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_3_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Assault", 
              "(Non-Sexual, Non-Domestic Violence)",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_3_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_3_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Burglary 
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_4`
(`r P_HXCat12_4`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for burglary. Table
\ref{tab:describe_burglary} summarizes the counts of unique burglary incidents
overall and by when the incident occurred, while Table \ref{tab:freq_HXCat12_4}
shows the frequency distributions underlying those summaries.

```{r describe_burglary}
# Table caption. 
TCap <- paste("Offender-Level Burglary Incident Counts (Overall and By When",
              "Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_4, HXCat12_4_Before, HXCat12_4_During, HXCat12_4_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_4}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Burglary Incidents for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall and",
              "By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_4, HXCat12_4_Before, HXCat12_4_During, HXCat12_4_After) %>% 
  rename(All = HXCat12_4, Before = HXCat12_4_Before, During = HXCat12_4_During, 
         After = HXCat12_4_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the burglary incident counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_4_gee}
HXCat12_4_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_4 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_4_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_4 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_4_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_4_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Burglary Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_4_gee1, HXCat12_4_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_4_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_4_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_4_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Burglary Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_4_emmeans1 <- emmeans(HXCat12_4_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_4_emmeans2 <- emmeans(HXCat12_4_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_4_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_4_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_4_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_4_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Burglary",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_4_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_4_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Criminal Sexual Conduct
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_5`
(`r P_HXCat12_5`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for criminal sexual
conduct. Table \ref{tab:describe_csc} summarizes the counts of unique criminal
sexual conduct incidents overall and by when the incident occurred, while Table
\ref{tab:freq_HXCat12_5} shows the frequency distributions underlying those
summaries.

```{r describe_csc}
# Table caption. 
TCap <- paste("Offender-Level Criminal Sexual Conduct Incidents (Overall and",
              "By When Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_5, HXCat12_5_Before, HXCat12_5_During, HXCat12_5_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_5}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Criminal Sexual Conduct",
              "Incidents for Which Offender Was Arrested, Charged, or",
              "Convicted (Overall and By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_5, HXCat12_5_Before, HXCat12_5_During, HXCat12_5_After) %>% 
  rename(All = HXCat12_5, Before = HXCat12_5_Before, 
         During = HXCat12_5_During, After = HXCat12_5_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the criminal sexual conduct incident counts, we fitted
two generalized estimating equation (GEE) models to the long-format *IDNEWL*
data, after dropping rows for unobserved periods (*Years* = 0) because the
counts are missing for those observations.

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_5_gee}
HXCat12_5_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_5 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_5_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_5 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_5_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_5_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Criminal Sexual",
              "Conduct Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_5_gee1, HXCat12_5_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_5_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_5_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_5_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Criminal Sexual Conduct Incident Counts and",
              "Incidence Rates By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_5_emmeans1 <- emmeans(HXCat12_5_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_5_emmeans2 <- emmeans(HXCat12_5_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_5_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_5_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_5_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_5_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Criminal",
              "Sexual Conduct Incident Counts and Incidence Rates By When",
              "Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_5_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_5_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Drug Crime 
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_6`
(`r P_HXCat12_6`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for drug crime. Table
\ref{tab:describe_drug} summarizes the counts of unique drug crime incidents 
overall and by and when the incident occurred, while Table
\ref{tab:freq_HXCat12_6} shows the frequency distributions underlying those
summaries.

```{r describe_drug}
# Table caption. 
TCap <- paste("Offender-Level Drug Crime Incident Counts (Overall and By When",
              "Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_6, HXCat12_6_Before, HXCat12_6_During, HXCat12_6_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_6}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Drug Crime Incidents for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall and",
              "By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_6, HXCat12_6_Before, HXCat12_6_During, HXCat12_6_After) %>% 
  rename(All = HXCat12_6, Before = HXCat12_6_Before, During = HXCat12_6_During, 
         After = HXCat12_6_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the drug crime incident counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_6_gee}
HXCat12_6_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_6 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_6_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_6 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_6_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_6_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Drug Crime Incident",
              "Counts Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_6_gee1, HXCat12_6_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_6_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_6_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_6_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Drug Crime Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_6_emmeans1 <- emmeans(HXCat12_6_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_6_emmeans2 <- emmeans(HXCat12_6_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_6_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_6_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_6_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_6_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Drug Crime",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_6_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_6_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Homicide 
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_7`
(`r P_HXCat12_7`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for homicide. Table
\ref{tab:describe_homicide} summarizes the counts of unique homicide incidents
overall and by when the incident occurred, while Table \ref{tab:freq_HXCat12_7} 
shows the frequency distributions underlying those summaries.

```{r describe_homicide}
# Table caption. 
TCap <- paste("Offender-Level Homicide Incident Counts (Overall and By When",
              "Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_7, HXCat12_7_Before, HXCat12_7_During, HXCat12_7_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_7}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Homicide Incidents for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall and",
              "By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_7, HXCat12_7_Before, HXCat12_7_During, HXCat12_7_After) %>% 
  rename(All = HXCat12_7, Before = HXCat12_7_Before, During = HXCat12_7_During, 
         After = HXCat12_7_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the homicide incident counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_7_gee}
HXCat12_7_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_7 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_7_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_7 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_7_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_7_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Homicide Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_7_gee1, HXCat12_7_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_7_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_7_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_7_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Homicide Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_7_emmeans1 <- emmeans(HXCat12_7_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_7_emmeans2 <- emmeans(HXCat12_7_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_7_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_7_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_7_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_7_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Homicide",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_7_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_7_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Larceny/Theft/Fraud 
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_8`
(`r P_HXCat12_8`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for larceny, theft, or
fraud. Table \ref{tab:describe_larceny} summarizes the counts of unique larceny,
theft, or fraud incidents overall and by when the incident occurred, while
Table \ref{tab:freq_HXCat12_8} shows the frequency distributions underlying 
those summaries.

```{r describe_larceny}
# Table caption. 
TCap <- paste("Offender-Level Larceny, Theft, or Fraud Incidents (Overall and",
              "By When Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_8, HXCat12_8_Before, HXCat12_8_During, HXCat12_8_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_8}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Larceny, Theft, or Fraud",
              "Incidents for Which Offender Was Arrested, Charged, or",
              "Convicted (Overall and By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_8, HXCat12_8_Before, HXCat12_8_During, HXCat12_8_After) %>% 
  rename(All = HXCat12_8, Before = HXCat12_8_Before, 
         During = HXCat12_8_During, After = HXCat12_8_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the larceny, theft or fraud incident counts, we fitted
two generalized estimating equation (GEE) models to the long-format *IDNEWL*
data, after dropping rows for unobserved periods (*Years* = 0) because the
counts are missing for those observations.

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_8_gee}
HXCat12_8_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_8 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_8_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_8 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_8_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_8_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Larceny, Theft, or",
              "Fraud Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_8_gee1, HXCat12_8_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_8_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_8_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_8_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Larceny, Theft, or Fraud Incident Counts and",
              "Incidence Rates By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_8_emmeans1 <- emmeans(HXCat12_8_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_8_emmeans2 <- emmeans(HXCat12_8_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_8_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_8_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_8_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_8_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Larceny,",
              "Theft, or Fraud Incident Counts and Incidence Rates By When",
              "Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_8_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_8_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Robbery
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_9`
(`r P_HXCat12_9`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for robbery. Table
\ref{tab:describe_robbery} summarizes the counts of unique robbery incidents 
overall and by when the incident occurred, while Table \ref{tab:freq_HXCat12_9} 
shows the frequency distributions underlying those summaries.

```{r describe_robbery}
# Table caption. 
TCap <- paste("Offender-Level Robbery Incident Counts (Overall and By When",
              "Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_9, HXCat12_9_Before, HXCat12_9_During, HXCat12_9_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_9}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Robbery Incidents for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall and",
              "By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_9, HXCat12_9_Before, HXCat12_9_During, HXCat12_9_After) %>% 
  rename(All = HXCat12_9, Before = HXCat12_9_Before, During = HXCat12_9_During, 
         After = HXCat12_9_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>% 
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the robbery incident counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_9_gee}
HXCat12_9_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_9 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_9_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_9 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_9_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_9_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Robbery Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_9_gee1, HXCat12_9_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_9_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_9_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_9_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Robbery Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_9_emmeans1 <- emmeans(HXCat12_9_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_9_emmeans2 <- emmeans(HXCat12_9_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_9_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_9_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_9_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_9_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Robbery",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_9_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_9_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Sex Crimes
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_10`
(`r P_HXCat12_10`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for sex crimes. Table
\ref{tab:describe_sexcrime} summarizes the counts of unique sex crime incidents
overall and by when the incident occurred, while Table \ref{tab:freq_HXCat12_10} 
shows the frequency distributions underlying those summaries.

```{r describe_sexcrime}
# Table caption. 
TCap <- paste("Offender-Level Sex Crime Incident Counts (Overall and By When",
              "Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_10, HXCat12_10_Before, HXCat12_10_During, HXCat12_10_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_10}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Sex Crime Incidents for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall and",
              "By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_10, HXCat12_10_Before, HXCat12_10_During, HXCat12_10_After) %>% 
  rename(All = HXCat12_10, Before = HXCat12_10_Before, During = HXCat12_10_During, 
         After = HXCat12_10_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>%
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the sex crime incident counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_10_gee}
HXCat12_10_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_10 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_10_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_10 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_10_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_10_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Sex Crime Incident",
              "Counts Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_10_gee1, HXCat12_10_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_10_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_10_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_10_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Sex Crime Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_10_emmeans1 <- emmeans(HXCat12_10_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_10_emmeans2 <- emmeans(HXCat12_10_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_10_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_10_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_10_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_10_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Sex Crime",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_10_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_10_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Traffic and Ordinances
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_11`
(`r P_HXCat12_11`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for traffic and
ordinance violations. Table \ref{tab:describe_traffic} summarizes the counts of
unique traffic and ordinance incidents overall and by when the incident
occurred, while Table \ref{tab:freq_HXCat12_11} shows the frequency
distributions underlying those summaries.

```{r describe_traffic}
# Table caption. 
TCap <- paste("Offender-Level Traffic and Ordinance Incidents (Overall and",
              "By When Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_11, HXCat12_11_Before, HXCat12_11_During, HXCat12_11_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_11}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Traffic and Ordinance",
              "Incidents for Which Offender Was Arrested, Charged, or",
              "Convicted (Overall and By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_11, HXCat12_11_Before, HXCat12_11_During, HXCat12_11_After) %>% 
  rename(All = HXCat12_11, Before = HXCat12_11_Before, 
         During = HXCat12_11_During, After = HXCat12_11_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>% 
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the traffic and ordinance incident counts, we fitted
two generalized estimating equation (GEE) models to the long-format *IDNEWL*
data, after dropping rows for unobserved periods (*Years* = 0) because the
counts are missing for those observations.

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_11_gee}
HXCat12_11_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_11 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_11_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_11 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_11_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_11_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Traffic and",
              "Ordinance Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_11_gee1, HXCat12_11_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_11_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_11_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_11_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Traffic and Ordinance Incident Counts and",
              "Incidence Rates By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_11_emmeans1 <- emmeans(HXCat12_11_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_11_emmeans2 <- emmeans(HXCat12_11_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_11_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_11_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_11_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_11_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Traffic and",
              "Ordinance Incident Counts and Incidence Rates By When",
              "Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_11_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_11_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

### Weapons
Among these `r N_IDNEW` suspected sexual offenders, there were `r N_HXCat12_12`
(`r P_HXCat12_12`\%) offenders who had criminal histories containing at least one
incident associated with an arrest, charge, or conviction for weapons crimes.
Table \ref{tab:describe_weapons} summarizes the counts of unique weapons crime
incidents overall and by when the incident occurred, while Table
\ref{tab:freq_HXCat12_12} shows the frequency distributions underlying those
summaries.

```{r describe_weapons}
# Table caption. 
TCap <- paste("Offender-Level Weapons Crime Incident Counts (Overall and By",
              "When Incident Occurred)")

# Summarize crime category counts (both overall and broken down by IWhen).
IDNEW %>% 
  select(HXCat12_12, HXCat12_12_Before, HXCat12_12_During, HXCat12_12_After) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  bind_cols(data.frame(Variable = TRowLabs), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap,
        linesep = c('', '', '', '\\addlinespace')) %>% 
  column_spec(column = 1, width = "6 cm") %>% 
  footnote(general = FN1, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

```{r freq_HXCat12_12}
# Table caption.
TCap <- paste("Frequency Distributions for Number of Weapons Crime Incidents for",
              "Which Offender Was Arrested, Charged, or Convicted (Overall and",
              "By When Incident Occurred)")

# Get frequency distributions. 
IDNEW %>% 
  select(OID, HXCat12_12, HXCat12_12_Before, HXCat12_12_During, HXCat12_12_After) %>% 
  rename(All = HXCat12_12, Before = HXCat12_12_Before, During = HXCat12_12_During, 
         After = HXCat12_12_After) %>% 
  pivot_longer(cols = -OID, names_to = "When", values_to = "Value") %>% 
  group_by(When, Value) %>% 
  count() %>% 
  arrange(Value) %>% 
  pivot_wider(names_from = When, values_from = n, values_fill = 0) %>% 
  mutate(All_p = 100*All/N_All,
         All_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_All),
         Before_p = 100*Before/N_All,
         Before_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*Before/N_Before),
         During_p = 100*During/N_All,
         During_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*During/N_During),
         After_p = 100*After/N_All,
         After_v = if_else(is.na(Value), 
                            true = as.numeric(NA), 
                            false = 100*After/N_After)) %>% 
  select(Value, All, All_p, All_v, Before, Before_p, Before_v, During, 
         During_p, During_v, After, After_p, After_v) %>% 
  kable(format = "latex", booktabs = TRUE, digits = 2, 
        col.names = c("Value", rep(c("N", "%", "Valid %"), 4)),
        caption = TCap) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 1, "Overall" = 3, "Before TW" = 3, "During TW" = 3,
                   "After TW" = 3)) %>% 
  footnote(general = FN5, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier 

#### GEE Models
To more closely examine the weapon incident counts, we fitted two generalized
estimating equation (GEE) models to the long-format *IDNEWL* data, after
dropping rows for unobserved periods (*Years* = 0) because the counts are
missing for those observations. 

Model 1 used *When* as a predictor of the period-specific counts, but did not
adjust for the period durations. Model 2 supplemented *When* as a predictor with
an offset term for log(*Years*) to adjust for the period durations. Both models
used Poisson distributions, an exchangeable correlation structure, a log link
function, and robust standard errors based on the sandwich estimator. 

```{r HXCat12_12_gee}
HXCat12_12_gee1 <- IDNEWL %>% 
  filter(Years > 0) %>%
  geeglm(HXCat12_12 ~ When, 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")

HXCat12_12_gee2 <- IDNEWL %>% 
  filter(Years > 0) %>% 
  geeglm(HXCat12_12 ~ When + offset(log(Years)), 
         family = poisson(link = "log"), data = ., 
         id = OID, corstr = "exchangeable", std.err = "san.se")
```

Table \ref{tab:HXCat12_12_texreg} below shows the parameter estimates for both 
GEE models. 

```{r HXCat12_12_texreg, results = "asis", cfsize = "normalsize"}
TCap <- paste("Generalized Estimating Equation Models for Weapon Incident Counts",
              "Predicted by When Incidents Occurred")
FN <- paste ("\\item * p < .05, null hypothesis value outside 95\\% confidence",
             "interval based on z-score.",
             "\\\\\n\\item Note.",
             "The data contain up to 3 longitudinal observations (one per", 
             "period) for each offender (i.e., cluster).",
             "The reference priod for When was after the testing window.",
             "Both models used a log link function, exchangeable correlation", 
             "structure, a Poisson distribution, and robust standard errors",
             "(sandwich estimator).",
             "Model 1 did not use an offset.",
             "Model 2 used log(Years) as an offset term.")

texreg(list(HXCat12_12_gee1, HXCat12_12_gee2), booktabs = TRUE, dcolumn = TRUE,
       threeparttable = TRUE, fontsize = "normalsize", table = TRUE, 
       use.packages = FALSE, ci.force = TRUE, label = "tab:HXCat12_12_texreg",
       stars = 0.05, caption = TCap, custom.note = FN)
```

\FloatBarrier

#### Estimated Marginal Means
Table \ref{tab:HXCat12_12_emmeans} provides the estimated marginal means obtained
from Models 1 and 2, along with corresponding confidence intervals. The units of
measurement for those means are counts per offender for Model 1 (which ignore
period duration) and counts per offender-year for Model 2 (which adjust for
duration and are thus considered annual incidence rates).

```{r HXCat12_12_emmeans}
# Table caption.
TCap <- paste("Marginal Means of Weapon Incident Counts and Incidence Rates",
              "By When Incidents Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "Confidence intervals are based on z-scores.")

HXCat12_12_emmeans1 <- emmeans(HXCat12_12_gee1, specs = pairwise ~ When, 
                           type = "response", ref = "During")
HXCat12_12_emmeans2 <- emmeans(HXCat12_12_gee2, specs = pairwise ~ When, 
                           type = "response", ref = "During")

as_tibble(HXCat12_12_emmeans1$emmeans) %>% 
  full_join(x = ., y = as_tibble(HXCat12_12_emmeans2$emmeans)) %>% 
  mutate(Model = c(1, 1, 1, 2, 2, 2), 
         When = factor(When, levels = c("Before", "During", "After"))) %>% 
  arrange(Model, When) %>% 
  select(When, rate, SE, df, asymp.LCL, asymp.UCL) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("When", "Rate", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Mean per offender", start_row = 1,
             end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Mean per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

#### Contrasts for Ratios of Estimated Marginal Means
Finally, we also estimated a set of contrasts to compare the marginal means from
Models 1 and 2 (Table \ref{tab:HXCat12_12_ratios}). Each of these contrasts
estimates the ratios of a pair of means rather than a raw difference between
means. This is because of the nature of the underlying Poisson GEE model.

```{r HXCat12_12_ratios}
TCap <- paste("Contrasts Estimating Ratios of Marginal Means for Weapon",
              "Incident Counts and Incidence Rates By When Incidents",
              "Occurred")

# Table footnote.
FN <- paste("Model 1 did not use an offset, so means are counts.",
            "Model 2 used log(Years) as an offset term, so means are annual",
            "incidence rates.",
            "These contrasts estimate ratios of those quantities and used",
            "Tukey's method to adjust for multiple comparisons.",
            "Confidence intervals are based on z-scores.")

as_tibble(confint(HXCat12_12_emmeans1$contrasts)) %>% 
  full_join(x = ., y = as_tibble(confint(HXCat12_12_emmeans2$contrasts))) %>% 
  kable(format = "latex", booktabs = TRUE, caption = TCap, digits = 2, 
        col.names = c("Contrast", "Ratio", "SE", "df", "LCL", "UCL")) %>% 
  kable_styling() %>% 
  add_header_above(c(" " = 4, "95% CI" = 2)) %>% 
  group_rows(group_label = "Model 1: Ratios of means per offender", 
             start_row = 1, end_row = 3, italic = TRUE) %>% 
  group_rows(group_label = "Model 2: Ratios of means per offender-year", 
             start_row = 4, end_row = 6, italic = TRUE) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

# Arrest Offense Record Summaries
All summaries in this section directly summarize the ARR data without first 
aggregating to the incident or offender level. 

\FloatBarrier

## Crime Category (12 levels)
```{r}
FN <- paste("Only arrest records for offenders with valid testing window start",
            "dates and with offenses from the 12 main crime categories were",
            "included.")

kable(freq(as_factor(ARREW$ACat12), user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Arrest Offense Records by Crime Category (12 levels)") %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

## Age at Arrest for Criminal Sexual Conduct
```{r describe_OAgeA}
# Table caption. 
TCap <- paste("Offender Age at Arrest for Criminal Sexual Conduct (Overall)")
# Footnote text. 
FN <- paste("This is an arrest offense record-level summary (offenders with",
            "multiple arrests contribute one age value per arrest record.",
            "Only arrest records for offenders with valid testing window start",
            "dates and where the arrest was for criminal sexual conduct are",
            "included.")

ARREW %>% 
  filter(ACat12_5 == 1) %>% 
  select(OAgeA, ALag) %>% 
  describe(., quant=c(.25, .50, .75)) %>% 
  filter(vars == 1) %>% 
  bind_cols(data.frame(Variable = "Age at arrest"), .) %>% 
  select(Variable, n, mean, sd, min, max, skew, kurtosis, Q0.25, Q0.5, Q0.75) %>% 
  kable(., format = "latex", booktabs = TRUE, digits = 2, row.names = FALSE, 
        col.names = CNames, caption = TCap) %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

# Prosecutor Charge Record Summaries
This section directly summarizes the CHG data without first aggregating to the 
incident or offender level. 

\FloatBarrier

```{r, fig.height = 2}
FN <- paste("Only charge records for offenders with valid testing window start",
            "dates and with charges from the 12 main crime categories were",
            "included.")

kable(freq(as_factor(CHGEW$CCat12), user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Prosecutor Charge Records by Crime Category (12 levels)") %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

\FloatBarrier

# Judicial Charge Record Summaries
All summaries in this section directly summarize the JUD data without first 
aggregating to the incident or offender level. While some of these records are 
convictions, others will have other dispositions.

\FloatBarrier

## Crime Category (12 levels, all dispositions)
```{r, fig.height = 2}
FN <- paste("Only records for offenders with valid testing window start dates",
            "and with charges from one of the 12 main crime categories were",
            "included.")

kable(freq(as_factor(JUDEW$JCat12), user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Adjudicated Charge Records (All Dispositions) by Crime Category (12 levels)")
```

\FloatBarrier

## Crime Category (12 levels, convictions)
```{r, fig.height = 2}
FN <- paste("Only conviction records for offenders with valid testing window",
            "start dates and with charges from one of the 12 main crime",
            "categories were included.")

kable(freq(as_factor(CONEW$JCat12), user.missing = "Excluded user-missing"), 
      format = "latex", booktabs = TRUE, digits = 2, 
      format.args = list(big.mark = ','),
      caption = "Number of Adjudicated Charge Records (Convictions Only) by Crime Category (12 levels)") %>% 
  footnote(general = FN, general_title = "Note: ", footnote_as_chunk = TRUE,
         threeparttable = TRUE)
```

********************************************************************************
# Wrap Up

\FloatBarrier

## Project Information
These materials are scholarly products based on research funded by the following 
grant. 

Campbell, R., Pierce, S. J., & Sharma, D. (01/01/2015–12/31/2018). Serial sexual
assaults: A longitudinal examination of offending patterns using DNA evidence.
[NIJ Award # 2014-NE-BX-0006, Awarded, $699,533]. Sponsor: National Institute of
Justice. Location: Michigan State University, East Lansing, MI.

\FloatBarrier

## References
Campbell, R. (2019). *Serial sexual assaults: A longitudinal examination of
offending patterns using DNA evidence, Detroit, Michigan, 2009* [Data files,
codebooks, computer programs, and statistical output]. ICPSR37134-v1. Ann Arbor,
MI: Inter-university Consortium for Political and Social Research [distributor],
2019-02-28. Retrieved from: https://doi.org/10.3886/ICPSR37134.v1

\FloatBarrier

## Software Information
We use R Markdown to enhance reproducibility. Knitting the source R Markdown 
script *`r knitr:::current_input()`* generates this PDF file containing 
explanatory text, R code, plus R output (text and graphics).

- We used [RStudio](www.rstudio.org) `r rstudioapi::versionInfo()$version` to 
  work with R and R markdown files. The software chain looks like this:
  **Rmd file > RStudio > R > rmarkdown > knitr > pandoc > TinyTeX or MiKTeX > PDF file**.
- We recommend using [TinyTeX](https://yihui.org/tinytex/) to compile LaTeX files 
  into PDF files. However, it should be viable to use 
  [MiKTeX version 2.9](https://miktex.org) instead. 
- We used [pandoc](https://pandoc.org) `r pandoc_version()` for this 
  document. 

This document was generated using the following computational environment and 
dependencies: 

``` {r show_citations}
# If is_tineytex = TRUE, then we used TinyTex, otherwise we used MikTeX. 
tinytex:::is_tinytex()

# Get R and R package version numbers in use.
devtools::session_info()
```

The current Git commit details and status are:

```{r git_details, eval=TRUE}
# Store whether git2r is installed and we are in a git repository.
GitCheck <- "git2r" %in% installed.packages() & git2r::in_repository(path = ".")
if(!GitCheck) cat(paste0("GitCheck = ", GitCheck, 
                         ". Version control details not available. \n"))

# What commit is this file at? 
if (GitCheck) git2r::repository(here::here())

# What is the repository status? 
if (GitCheck) git2r::status()
```
