---
title: \sffamily{\bfseries{\LARGE Criminal History Records Paper Step 1 (Data Management)}}
geometry: "left=.5in,right=.5in,top=.75in,bottom=.75in"
author: "Steven J. Pierce"
output:
 pdf_document:
   latex_engine: xelatex
   number_sections: true
   toc: yes
   toc_depth: 3
   includes:
     in_header: "../compact-title.tex"
urlcolor: blue
header-includes:
- \usepackage{fancyhdr}
- \usepackage[yyyymmdd,hhmmss]{datetime}
- \usepackage{lastpage}
- \usepackage{fontspec}
- \defaultfontfeatures{Ligatures=TeX}
- \usepackage[font={small}, margin=1cm, skip=2pt]{caption}
- \usepackage{url}
- \usepackage{floatrow}
- \floatplacement{figure}{!ht}
- \floatplacement{table}{!ht}
- \usepackage{placeins}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{dcolumn}
- \usepackage{titling}
- \usepackage{threeparttable}
- \usepackage{threeparttablex}
- \pretitle{\begin{center}\LARGE\bfseries}
- \posttitle{\end{center}}
- \pagestyle{fancy}
- \lhead{SSA CHR Paper Step 1 Data Mgt}
- \rhead{\today\ \currenttime}
- \lfoot{\texttt{\small \detokenize{`r sub(".Rmd", ".pdf", knitr:::current_input(dir = FALSE))`}}} 
- \cfoot{ }
- \fancyfoot[R]{\thepage\ of \pageref*{LastPage}}
- \renewcommand{\headrulewidth}{0.4pt}
- \renewcommand{\footrulewidth}{0.4pt}
- \fancypagestyle{plain}{\pagestyle{fancy}}
---

********************************************************************************  
\FloatBarrier

# Purpose.
This file imports copies of publicly archived data files (Campbell, 2019) into 
R, then performs data management to prepare a new data file for a descriptive 
paper about the criminal histories of suspected serial sexual offenders.  


\FloatBarrier

# Setup
Set global R chunk options (local chunk options will over-ride global options). 

``` {r global_options}
# Global chunk options (over-ridden by local chunk options)
knitr::opts_chunk$set(include  = TRUE, echo = TRUE, error = TRUE, 
                      message = TRUE, warning = TRUE)
```

If you have not already done so, install the piercer package from 
[GitHub](https://github.com/sjpierce/piercer) by running the next chunk of R 
code. The chunk is set to eval = FALSE so that you have to manually run that 
code, which you should only need to do once (or whenever the piercer package 
has been updated). 

```{r, eval = FALSE}
install.packages("devtools")
library(devtools)
devtools::install_github("sjpierce/piercer")
```

Load R packages that we need to get additional functions. 

``` {r load_packages}
library(here)         # for here()
library(dplyr)        # for %>%, filter(), group_by(), & summarise()
library(tidyr)        # for arrange(), filter(), group_by(), mutate(), spread(), 
                      # summarise(), %>%, etc. 
library(rmarkdown)    # for render()
library(knitr)        # for kable()
options(kableExtra.latex.load_packages = FALSE)
library(kableExtra)   # for kable_styling(), add_header_above(), column_spec(),
                      # collapse_rows(), and landscape()
library(descr)            # For freq().
options(descr.plot=FALSE) # Make freq() & crosstab() skip plots by default.
library(lubridate)        # For date conversion, eg. ymd(), time_length().
library(sjlabelled) # For set_label(), get_label()
library(haven)      # for read_spss()
library(lattice)          # For xyplot(), bwplot(), etc. 
library(piercer)    # for DI() and tag_um()
library(plyr)             # For mapvalues()
library(psych)            # For describe()
library(car)              # For recode()
```

Create objects to hold objects with settings we want to reuse. 

```{r my_settings}
# Custom settings for use with bwplot().
my.boxes <- list(box.rectangle = list(col = "black", lwd = 2), 
                 box.umbrella = list(col = "black", lwd = 2))
```

\FloatBarrier

# Import Files
The SPSS files we will need to import, plus docmentation about their contents
and relationships between them, are available from an online archive (Campbell,
2019).

\FloatBarrier

## Core Criminal History Records (CHR) Files
Import the SPSS data files for the five core types of records comprising
Michigan criminal history records (CHR): offenders (IDN), incidents (INC),
arrest offenses (ARR), prosecutor charges (CHG), and judicial charges (JUD). 
See Campbell (2019) for details on these files. 

``` {r import_chr}
# Read SPSS data files.
IDN <- read_sav("data/SSA_IDN_Offenders_2018-09-03.sav", user_na = TRUE)
INC <- read_sav("data/SSA_INC_Incidents_Imputed_2018-09-03.sav", user_na = TRUE)
ARR <- read_sav("data/SSA_ARR_Arrests_Imputed_2018-09-03.sav", user_na = TRUE)
CHG <- read_sav("data/SSA_CHG_PA_Charges_Imputed_2018-09-03.sav", 
                user_na = TRUE)
JUD <- read_sav("data/SSA_JUD_Judicial_Charges_Imputed_2018-09-03.sav", 
                user_na = TRUE) 

# Replace user-missing value labels that have parentheses in them so they will
# work correctly in freq() as user.missing arguments. 
ARR$ACat12 <- rvlabel(ARR$ACat12)
ARR$ACat10 <- rvlabel(ARR$ACat10)
ARR$ACat04 <- rvlabel(ARR$ACat04)
ARR$ACat03 <- rvlabel(ARR$ACat03)
CHG$CCat12 <- rvlabel(CHG$CCat12)
CHG$CCat10 <- rvlabel(CHG$CCat10)
CHG$CCat04 <- rvlabel(CHG$CCat04)
CHG$CCat03 <- rvlabel(CHG$CCat03)
JUD$JCat12 <- rvlabel(JUD$JCat12)
JUD$JCat10 <- rvlabel(JUD$JCat10)
JUD$JCat04 <- rvlabel(JUD$JCat04)
JUD$JCat03 <- rvlabel(JUD$JCat03)

# Create a subset of JUD containing only charges where offender was convicted.
CON <- JUD[JUD$JDispCat == 1,]

# Add a variable to CON to simplify aggregation. 
CON$NCON <- 1
```

\FloatBarrier

## Additional Data Files
We may or may not need these additional data files. We will come back and edit 
this section later to remove anything we don't need. See Campbell (2019) for 
details on these files. 

``` {r import_other}
# Read SPSS data files.
ESC <- read_sav("data/ESCALATIONdata_2018-05-15.sav", user_na = TRUE)
FOR <- read_sav("data/Forensic_Outcomes_2018-04-03.sav", user_na = TRUE)
PER <- read_sav("data/PERPdata_2018-04-03.sav", user_na = TRUE)
SPD <- read_sav("data/SAK_PERP_2018-04-03.sav", user_na = TRUE)
SAK <- read_sav("data/SAKdata_2018-04-03.sav", user_na = TRUE) 
```

\FloatBarrier

# Criminal History Record (CHR) Count Overview
Below is a summary of the record counts for different types of CHR records, 
along with the numbers of unique incidents and unique offenders represented in
those records. It also shows the range of event dates associated with each 
record type (i.e., birth, incident, arrest, charge, and adjudication dates). 

```{r, warning = FALSE}
# Summarize record counts.
CHR.RC <- rbind(dfsummary(IDN, label = "Offenders", dvar = IDN$DOB),
                dfsummary(INC, label = "Incidents", dvar = INC$IDate), 
                dfsummary(ARR, label = "Arrest offenses", dvar = ARR$ADate),
                dfsummary(CHG, label = "Prosecutor charges", dvar = CHG$CDate),
                dfsummary(JUD, label = "Adjudicated charges (all dispositions)", 
                          dvar = JUD$JDate),
                dfsummary(CON, label = "Adjudicated charges (convictions)", 
                          dvar = CON$JDate))
kable(CHR.RC, caption = "Criminal History Record Counts and Date Ranges", 
      format.args = list(big.mark = ','))
```

Note: Knitting the file will produce a warning message: "Unknown column 'IID'"
because the IDN data frame does not contain an IID column. The *dfsummary()* 
function doesn't try to check that before calculating N.Incidents. However, it
correctly returns N.Incidents = 0 for the IDN data frame. 

\FloatBarrier

# Offender-Level Summaries
We have few offender-level demographic variables that are worth reporting (we 
will omit summarizing height, weight, hair color, & eye color). After examining
sex, race, and age, we switch focus to looking at descriptive data about the 
criminal history records for arrests, prosecutor charges, and adjudicated 
charges. 

All the CHR summaries in this section focus on variables that have been 
aggregated to offender level. That is why the sample size for all of these
variables is N = 1,143 (the number of offenders for whom Michigan CHR data were
available). 

\FloatBarrier

## Sex
```{r}
kable(freq(as_factor(IDN$Sex)),  digits = 2, caption = "Offender Sex")
```

\FloatBarrier

## Race
```{r}
kable(freq(as_factor(IDN$Race), user.missing = "Unknown"),  digits = 2, 
      caption = "Offender Race")
```

\FloatBarrier

## Age (as of 04/15/2016)
```{r, fig.height = 2}
CNums  <- c(2:4,8,9,11:12, 14:16)
CNames <- c("N", "Mean", "SD", "Min", "Max", "Skew", "Kurtosis", "Q25", "Q50", 
            "Q75")
Age <- describe(IDN[, "Age"],  quant=c(.25, .50, .75))
kable(Age[, CNums], digits = 2, col.names = CNames,
      caption = "Offender Age (as of 04/15/2016)")
bwplot(~ Age, data = IDN, factor = 9, xlim = c(18, 82),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Offender Age (as of 04/15/2016)")
```

## CHR Record Counts
We aggregated data to count how many CHR records of each type are associated 
with each offender. We summarize the resulting variables (NINC, NARR, NCHG, 
NJUD, & NCON) below.

```{r}
## Aggregate by OID into a conviction charge count variable. 
CON2 <- aggregate(NCON ~ OID, data = CON, FUN=sum)

# Merge NCON conviction charge count variable into IDN.
IDN <- merge(x = IDN, y = CON2, by = "OID", all.x = TRUE)

# Recode NCON variable to replace NA with 0. 
IDN$NCON[is.na(IDN$NCON)] <- 0
  
# Summarize CHR record counts.
RC <- describe(IDN[, c("NINC", "NARR", "NCHG", "NJUD", "NCON")],  
               quant=c(.25, .50, .75))
row.names(RC) <- c("No. of incidents", 
                   "No. of arrest offenses", 
                   "No. of prosecutor charges", 
                   "No. of adjudicated charges (all)",
                   "No. of adjudicated charges (convictions)")
kable(RC[, CNums], digits = 2, col.names = CNames,
      caption = "Offender-Level Record Counts (All Crime Categories)")

kable(freq(IDN$NINC), digits = 2, 
      caption = "Number of Incidents (All Crime Categories)")

kable(freq(IDN$NARR), digits = 2,
      caption = "Number of Arrest Offenses (All Crime Categories)")

kable(freq(IDN$NCHG), digits = 2,
      caption = "Number of Prosecutor Charges (All Crime Categories)")

kable(freq(IDN$NJUD), digits = 2,
      caption = "Number of Adjudicated Charges (All Crime Categories, All Dispositions)")

kable(freq(IDN$NCON), digits = 2,
      caption = "Number of Adjudicated Charges (All Crime Categories, Convictions)")
```

```{r , fig.height = 3}
# Rearrange data so we can easily plot multiple variables. 
IDNW <- gather(data = IDN[, c("OID", "NINC", "NARR", "NCHG", "NJUD")], 
               key = VName, value = Count, NINC:NJUD)
IDNW$VName <- ordered(IDNW$VName, levels = c("NINC", "NARR", "NCHG", "NJUD"), 
                      labels = c("Incidents", "Arrest Offenses", 
                                 "Prosecutor Charges", "Adjudicated Charges"))
bwplot(VName ~ Count, data = IDNW, factor = 1, xlim = c(-4, 64),
       panel = panel.mybox, par.settings = my.boxes,
       xlab = "Number of Records for Individual Offender")
densityplot(~ Count | VName, data = IDNW, layout = c(4,1), 
            panel = panel.mydensity, jitter.amount = 0.005,
            strip = strip.custom(par.strip.text = list(cex = .7)),
            xlab = "Number of Records for Individual Offender")
rm(IDNW)
```


********************************************************************************
# Wrap Up

\FloatBarrier

## Project Information
These materials are scholarly products based on research funded by the following 
grant. 

Campbell, R., Pierce, S. J., & Sharma, D. (01/01/2015–12/31/2018). Serial sexual
assaults: A longitudinal examination of offending patterns using DNA evidence.
[NIJ Award # 2014-NE-BX-0006, Awarded, $699,533]. Sponsor: National Institute of
Justice. Location: Michigan State University, East Lansing, MI.

\FloatBarrier

## References
Campbell, R. (2019). *Serial sexual assaults: A longitudinal examination of
offending patterns using DNA evidence, Detroit, Michigan, 2009* [Data files,
codebooks, computer programs, and statistical output]. ICPSR37134-v1. Ann Arbor,
MI: Inter-university Consortium for Political and Social Research [distributor],
2019-02-28. Retrieved from: https://doi.org/10.3886/ICPSR37134.v1


\FloatBarrier

## Document Information
Folder: *`r getwd()`*

* Script: *`r knitr:::current_input()`*
* Output: *`r sub(".Rmd", ".pdf", knitr:::current_input())`*

\FloatBarrier

## Software Information
We use R Markdown to enhance reproducibility. Knitting the R Markdown script
generates the PDF file containing explanatory text, R code, plus R output 
(text and graphics) noted in the Document Information section above.

- We use [RStudio (version 1.2.5033 or later)](www.rstudio.org) to work with 
  R and R markdown files. The software chain looks like this:
  **Rmd file -> RStudio -> R -> knitr -> pandoc -> MiKTeX -> PDF file**.
- We recommend using [TinyTeX](https://yihui.org/tinytex/) to compile LaTeX files 
  into PDF files. However, it should be viable to use 
  [MiKTeX version 2.9](https://miktex.org) instead. 
  

``` {r show_citations}
sessionInfo()
citation("here")
citation("dplyr")
citation("tidyr")
citation("rmarkdown")
citation("knitr")
citation("kableExtra")
citation("sjlabelled")
citation("haven")
citation("piercer")
```
